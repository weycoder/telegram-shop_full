<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å - Telegram Shop</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* –ü–†–û–°–¢–´–ï –°–¢–ò–õ–ò –ö–û–¢–û–†–´–ï 100% –†–ê–ë–û–¢–ê–Æ–¢ */
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            padding: 20px;
        }

        .sidebar h2 {
            color: #3498db;
            margin-bottom: 30px;
        }

        .menu-item {
            padding: 15px;
            color: white;
            text-decoration: none;
            display: block;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .menu-item:hover {
            background: #34495e;
        }

        .menu-item.active {
            background: #3498db;
        }

        .content {
            flex: 1;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .table-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ë–õ–Ø–¢–¨ –°–ê–ô–î–ë–ê–† -->
        <div class="sidebar">
            <h2><i class="fas fa-crown"></i> –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨</h2>
            <div class="menu-item active" data-page="dashboard">
                <i class="fas fa-chart-line"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            </div>
            <div class="menu-item" data-page="products">
                <i class="fas fa-box"></i> –¢–æ–≤–∞—Ä—ã
            </div>
            <div class="menu-item" data-page="orders">
                <i class="fas fa-clipboard-list"></i> –ó–∞–∫–∞–∑—ã
            </div>
            <div class="menu-item" data-page="add">
                <i class="fas fa-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
            </div>
            <div class="menu-item" style="position: absolute; bottom: 20px; width: 210px;" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
            </div>
        </div>

        <!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ -->
        <div class="content">
            <!-- –®–ê–ü–ö–ê -->
            <div class="header">
                <h1 id="pageTitle">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
                <p id="lastUpdated">–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Ç–æ–ª—å–∫–æ —á—Ç–æ</p>
            </div>

            <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
            <div id="dashboard" class="page active">
                <div class="stats">
                    <div class="stat-card">
                        <h3 id="totalRevenue">0 ‚ÇΩ</h3>
                        <p>–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalOrders">0</h3>
                        <p>–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalProducts">0</h3>
                        <p>–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="pendingOrders">0</h3>
                        <p>–û–∂–∏–¥–∞—é—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏</p>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="loadStats()">
                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                </button>
            </div>

            <!-- –¢–û–í–ê–†–´ -->
            <div id="products" class="page hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏</h2>
                    <button class="btn btn-primary" onclick="showAddProduct()">
                        <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
                    </button>
                </div>

                <div class="table-container">
                    <table id="productsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th>–¶–µ–Ω–∞</th>
                                <th>–û—Å—Ç–∞—Ç–æ–∫</th>
                                <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- –ó–ê–ö–ê–ó–´ -->
            <div id="orders" class="page hidden">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏</h2>

                <div class="table-container">
                    <table id="ordersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px;">
                                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- –î–û–ë–ê–í–õ–ï–ù–ò–ï –¢–û–í–ê–†–ê -->
            <div id="add" class="page hidden">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä</h2>

                <div class="table-container">
                    <form id="addProductForm" style="display: flex; flex-direction: column; gap: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 10px; font-weight: bold;">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ *</label>
                            <input type="text" id="productName" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 10px; font-weight: bold;">–¶–µ–Ω–∞ (‚ÇΩ) *</label>
                            <input type="number" id="productPrice" required step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 10px; font-weight: bold;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                            <input type="number" id="productStock" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 10px; font-weight: bold;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                            <select id="productCategory" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                            </select>
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 10px; font-weight: bold;">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea id="productDescription" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 10px; font-weight: bold;">URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                            <input type="url" id="productImageUrl" placeholder="https://example.com/image.jpg" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <small>–ò–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</small>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="button" class="btn" onclick="showPage('products')" style="background: #95a5a6;">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ü–ò–ó–î–ï–¶ –ü–†–û–°–¢–û–ô –ò –†–ê–ë–û–ß–ò–ô JAVASCRIPT
        console.log('üöÄ –ê–î–ú–ò–ù–ö–ê –ó–ê–ü–£–©–ï–ù–ê');

        let products = [];
        let orders = [];

        // –ü–û–ö–ê–ó–ê–¢–¨ –°–¢–†–ê–ù–ò–¶–£
        function showPage(pageId) {
            console.log('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É:', pageId);

            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
                page.classList.remove('active');
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é
            const page = document.getElementById(pageId);
            if (page) {
                page.classList.remove('hidden');
                page.classList.add('active');
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ–Ω—é
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });

            document.querySelector(`.menu-item[data-page="${pageId}"]`)?.classList.add('active');

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const titles = {
                'dashboard': '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
                'products': '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏',
                'orders': '–ó–∞–∫–∞–∑—ã',
                'add': '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä'
            };

            if (titles[pageId]) {
                document.getElementById('pageTitle').textContent = titles[pageId];
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            if (pageId === 'dashboard') loadStats();
            if (pageId === 'products') loadProducts();
            if (pageId === 'orders') loadOrders();
            if (pageId === 'add') loadCategories();
        }

        // –ü–û–ö–ê–ó–ê–¢–¨ –£–í–ï–î–û–ú–õ–ï–ù–ò–ï
        function showAlert(message, type = 'success') {
            console.log('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:', message);

            const alert = document.createElement('div');
            alert.textContent = message;
            alert.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#2ecc71' : '#e74c3c'};
                color: white;
                padding: 15px 25px;
                border-radius: 5px;
                z-index: 9999;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            `;

            document.body.appendChild(alert);

            setTimeout(() => alert.remove(), 3000);
        }

        // –ó–ê–ì–†–£–ó–ò–¢–¨ –°–¢–ê–¢–ò–°–¢–ò–ö–£
        async function loadStats() {
            try {
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...');
                const response = await fetch('/api/admin/dashboard');

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }

                const data = await response.json();
                console.log('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:', data);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–∏—Ñ—Ä—ã
                document.getElementById('totalRevenue').textContent = formatPrice(data.total_revenue || 0) + ' ‚ÇΩ';
                document.getElementById('totalOrders').textContent = data.total_orders || 0;
                document.getElementById('totalProducts').textContent = data.total_products || 0;
                document.getElementById('pendingOrders').textContent = data.pending_orders || 0;

                document.getElementById('lastUpdated').textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date().toLocaleTimeString('ru-RU')}`;

                showAlert('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showAlert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'error');
            }
        }

        // –ó–ê–ì–†–£–ó–ò–¢–¨ –¢–û–í–ê–†–´
        async function loadProducts() {
            try {
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...');
                const response = await fetch('/api/admin/products');

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }

                products = await response.json();
                console.log('–¢–æ–≤–∞—Ä–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', products.length);

                renderProducts();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showAlert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤', 'error');
                products = [];
                renderProducts();
            }
        }

        // –û–¢–û–ë–†–ê–ó–ò–¢–¨ –¢–û–í–ê–†–´
        function renderProducts() {
            const tbody = document.getElementById('productsTableBody');

            if (!tbody) return;

            if (products.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            <i class="fas fa-box-open"></i>
                            <p>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';

            products.forEach(product => {
                html += `
                    <tr>
                        <td>${product.id}</td>
                        <td>
                            <img src="${product.image_url || 'https://via.placeholder.com/50'}"
                                 alt="${product.name}"
                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;"
                                 onerror="this.src='https://via.placeholder.com/50'">
                        </td>
                        <td>
                            <strong>${product.name}</strong>
                            ${product.description ? `<br><small>${product.description.substring(0, 50)}...</small>` : ''}
                        </td>
                        <td><strong>${formatPrice(product.price)} ‚ÇΩ</strong></td>
                        <td>
                            <span style="padding: 5px 10px; border-radius: 10px; background: ${product.stock > 10 ? '#d4edda' : '#fff3cd'}; color: ${product.stock > 10 ? '#155724' : '#856404'}">
                                ${product.stock} —à—Ç.
                            </span>
                        </td>
                        <td>${product.category || '‚Äî'}</td>
                        <td>
                            <button onclick="editProduct(${product.id})" style="background: #3498db; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin-right: 5px;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteProduct(${product.id})" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // –ó–ê–ì–†–£–ó–ò–¢–¨ –ó–ê–ö–ê–ó–´
        async function loadOrders() {
            try {
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...');
                const response = await fetch('/api/admin/orders');

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }

                orders = await response.json();
                console.log('–ó–∞–∫–∞–∑–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', orders.length);

                renderOrders();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showAlert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤', 'error');
                orders = [];
                renderOrders();
            }
        }

        // –û–¢–û–ë–†–ê–ó–ò–¢–¨ –ó–ê–ö–ê–ó–´
        function renderOrders() {
            const tbody = document.getElementById('ordersTableBody');

            if (!tbody) return;

            if (orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px;">
                            <i class="fas fa-clipboard-list"></i>
                            <p>–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';

            orders.forEach(order => {
                const items = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;
                const itemCount = Array.isArray(items) ? items.length : 0;
                const status = order.status || 'pending';

                const statusColors = {
                    'pending': '#fff3cd',
                    'processing': '#cce5ff',
                    'completed': '#d4edda',
                    'cancelled': '#f8d7da'
                };

                const statusText = {
                    'pending': '–û–∂–∏–¥–∞–µ—Ç',
                    'processing': '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ',
                    'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω',
                    'cancelled': '–û—Ç–º–µ–Ω–µ–Ω'
                }[status] || status;

                html += `
                    <tr>
                        <td><strong>#${order.id}</strong></td>
                        <td>${order.username || `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${order.user_id}`}</td>
                        <td><strong>${formatPrice(order.total_price)} ‚ÇΩ</strong></td>
                        <td>
                            <span style="padding: 5px 10px; border-radius: 10px; background: ${statusColors[status] || '#f8f9fa'};">
                                ${statusText}
                            </span>
                        </td>
                        <td>${new Date(order.created_at).toLocaleDateString('ru-RU')}</td>
                        <td>
                            <button onclick="viewOrder(${order.id})" style="background: #2ecc71; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // –ó–ê–ì–†–£–ó–ò–¢–¨ –ö–ê–¢–ï–ì–û–†–ò–ò
        async function loadCategories() {
            try {
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...');
                const response = await fetch('/api/admin/categories/manage');

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }

                const categories = await response.json();
                console.log('–ö–∞—Ç–µ–≥–æ—Ä–∏–π:', categories);

                const select = document.getElementById('productCategory');
                if (select) {
                    let options = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
                    categories.forEach(category => {
                        options += `<option value="${category}">${category}</option>`;
                    });
                    select.innerHTML = options;
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
                document.getElementById('productCategory').innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</option>';
            }
        }

        // –î–û–ë–ê–í–ò–¢–¨ –¢–û–í–ê–†
        async function addProduct(e) {
            e.preventDefault();

            const name = document.getElementById('productName').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const stock = parseInt(document.getElementById('productStock').value);
            const category = document.getElementById('productCategory').value;
            const description = document.getElementById('productDescription').value.trim();
            const imageUrl = document.getElementById('productImageUrl').value.trim();

            // –ü—Ä–æ–≤–µ—Ä–∫–∞
            if (!name || isNaN(price) || price <= 0 || isNaN(stock) || stock < 0) {
                showAlert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ', 'error');
                return;
            }

            const productData = {
                name: name,
                description: description,
                price: price,
                stock: stock,
                category: category,
                image_url: imageUrl || 'https://via.placeholder.com/300x200'
            };

            console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä:', productData);

            try {
                const response = await fetch('/api/admin/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(productData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');

                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('addProductForm').reset();
                    document.getElementById('productImageUrl').value = '';

                    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ç–æ–≤–∞—Ä–∞–º
                    showPage('products');
                    loadProducts();

                } else {
                    showAlert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showAlert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            }
        }

        // –†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ –¢–û–í–ê–†
        async function editProduct(id) {
            console.log('–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–æ–≤–∞—Ä #' + id);

            const product = products.find(p => p.id === id);
            if (!product) {
                showAlert('‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('productName').value = product.name;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productStock').value = product.stock;
            document.getElementById('productCategory').value = product.category || '';
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productImageUrl').value = product.image_url || '';

            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Ñ–æ—Ä–º—É
            showPage('add');

            // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            document.getElementById('pageTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä';

            // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É
            const form = document.getElementById('addProductForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-save"></i> –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
            submitBtn.classList.remove('btn-success');
            submitBtn.classList.add('btn-primary');

            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            form.removeEventListener('submit', addProduct);

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                const updatedData = {
                    name: document.getElementById('productName').value.trim(),
                    description: document.getElementById('productDescription').value.trim(),
                    price: parseFloat(document.getElementById('productPrice').value),
                    stock: parseInt(document.getElementById('productStock').value),
                    category: document.getElementById('productCategory').value,
                    image_url: document.getElementById('productImageUrl').value.trim()
                };

                try {
                    const response = await fetch(`/api/admin/products?id=${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updatedData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        showAlert('‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');

                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ä–º—É
                        form.reset();
                        submitBtn.innerHTML = '<i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä';
                        submitBtn.classList.remove('btn-primary');
                        submitBtn.classList.add('btn-success');
                        document.getElementById('pageTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';

                        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                        form.removeEventListener('submit', arguments.callee);
                        form.addEventListener('submit', addProduct);

                        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ç–æ–≤–∞—Ä–∞–º
                        showPage('products');
                        loadProducts();

                    } else {
                        showAlert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
                    showAlert('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞', 'error');
                }
            });
        }

        // –£–î–ê–õ–ò–¢–¨ –¢–û–í–ê–†
        async function deleteProduct(id) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä #${id}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
                return;
            }

            console.log('–£–¥–∞–ª—è–µ–º —Ç–æ–≤–∞—Ä #' + id);

            try {
                const response = await fetch(`/api/admin/products?id=${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('‚úÖ –¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω!');
                    loadProducts();
                } else {
                    showAlert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                showAlert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞', 'error');
            }
        }

        // –ü–û–°–ú–û–¢–†–ï–¢–¨ –ó–ê–ö–ê–ó
        function viewOrder(id) {
            const order = orders.find(o => o.id === id);
            if (!order) {
                showAlert('‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            const items = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;
            let itemsHtml = '';

            if (Array.isArray(items)) {
                itemsHtml = '<ul>';
                items.forEach(item => {
                    itemsHtml += `<li>${item.name} √ó ${item.quantity} = ${formatPrice(item.price * item.quantity)} ‚ÇΩ</li>`;
                });
                itemsHtml += '</ul>';
            } else {
                itemsHtml = '<p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–∞—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>';
            }

            const message = `
                <strong>–ó–∞–∫–∞–∑ #${order.id}</strong><br>
                –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${order.username || '–ì–æ—Å—Ç—å'}<br>
                –°—É–º–º–∞: ${formatPrice(order.total_price)} ‚ÇΩ<br>
                –°—Ç–∞—Ç—É—Å: ${order.status}<br>
                –î–∞—Ç–∞: ${new Date(order.created_at).toLocaleString('ru-RU')}<br>
                <br>
                <strong>–¢–æ–≤–∞—Ä—ã:</strong><br>
                ${itemsHtml}
            `;

            alert(message);
        }

        // –ü–û–ö–ê–ó–ê–¢–¨ –§–û–†–ú–£ –î–û–ë–ê–í–õ–ï–ù–ò–Ø –¢–û–í–ê–†–ê
        function showAddProduct() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('addProductForm').reset();
            document.getElementById('pageTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            const submitBtn = document.querySelector('#addProductForm button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä';
            submitBtn.classList.remove('btn-primary');
            submitBtn.classList.add('btn-success');

            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            const form = document.getElementById('addProductForm');
            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            document.getElementById('addProductForm').addEventListener('submit', addProduct);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            showPage('add');
        }

        // –§–û–†–ú–ê–¢–ò–†–û–í–ê–¢–¨ –¶–ï–ù–£
        function formatPrice(price) {
            return new Intl.NumberFormat('ru-RU').format(price || 0);
        }

        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        document.addEventListener('DOMContentLoaded', function() {
            console.log('–î–û–ú –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º...');

            // –ú–ï–ù–Æ
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const pageId = this.getAttribute('data-page');
                    showPage(pageId);
                });
            });

            // –ö–ù–û–ü–ö–ê –í–´–•–û–î–ê
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                    window.location.href = '/';
                }
            });

            // –§–û–†–ú–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –¢–û–í–ê–†–ê
            document.getElementById('addProductForm').addEventListener('submit', addProduct);

            // –ü–ï–†–í–ê–Ø –ó–ê–ì–†–£–ó–ö–ê
            loadStats();
            loadProducts();
            loadOrders();

            console.log('‚úÖ –ê–î–ú–ò–ù–ö–ê –ì–û–¢–û–í–ê –ö –†–ê–ë–û–¢–ï!');
        });
    </script>
</body>
</html>