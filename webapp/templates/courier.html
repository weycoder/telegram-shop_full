<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—É—Ä—å–µ—Ä—Å–∫–∞—è –ø–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/courier.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container" id="app">
        <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
        <div id="login-screen" class="login-form">
            <h2>üöö –í—Ö–æ–¥ –¥–ª—è –∫—É—Ä—å–µ—Ä–∞</h2>
            <div id="login-error" class="error-message" style="display: none;"></div>

            <div class="form-group">
                <label>–õ–æ–≥–∏–Ω:</label>
                <input type="text" id="login-username" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
            </div>

            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="login-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>

            <button class="btn" id="login-button">–í–æ–π—Ç–∏</button>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
        <div id="main-screen" style="display: none;">
            <div class="header">
                <h1>üöö –ö—É—Ä—å–µ—Ä—Å–∫–∞—è –ø–∞–Ω–µ–ª—å</h1>
                <p id="courier-info">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="available">üì¶ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã</div>
                <div class="tab" data-tab="orders">üöö –ú–æ–∏ –∑–∞–∫–∞–∑—ã</div>
                <div class="tab" data-tab="completed">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</div>
                <div class="tab" data-tab="stats">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                <div class="tab" data-tab="settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>

            <!-- –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã -->
            <div id="tab-available" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üì¶ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h2>
                    <button class="btn-action" id="refresh-available" style="background: #3498db; color: white;">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>

                <div id="available-orders-list" class="available-orders-grid">
                    <div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤...</div>
                </div>
            </div>

            <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã -->
            <div id="tab-orders" class="tab-content">
                <h2 style="margin-bottom: 20px;">üöö –ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
                <div id="active-orders-list" class="loader">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...
                </div>
            </div>

            <!-- –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã -->
            <div id="tab-completed" class="tab-content">
                <h2 style="margin-bottom: 20px;">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h2>
                <div id="completed-orders-list" class="loader">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div id="tab-stats" class="tab-content">
                <h2 style="margin-bottom: 20px;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-today">0</div>
                        <div class="stat-label">–ó–∞–∫–∞–∑–æ–≤ —Å–µ–≥–æ–¥–Ω—è</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-active">0</div>
                        <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-completed">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 15px 0;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
                <div id="recent-deliveries" class="loader">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
                </div>
            </div>

            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div id="tab-settings" class="tab-content">
                <h2 style="margin-bottom: 20px;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>

                <div id="settings-message"></div>

                <div class="profile-form">
                    <div class="profile-info">
                        <p><strong>–õ–æ–≥–∏–Ω:</strong> <span id="profile-username">-</span></p>
                        <p><strong>ID:</strong> <span id="profile-id">-</span></p>
                        <p><strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> <span id="profile-created">-</span></p>
                    </div>

                    <!-- –ë–ª–æ–∫ –ø—Ä–∏–≤—è–∑–∫–∏ Telegram -->
                    <div id="telegram-section" style="margin: 20px 0; padding: 15px; border-radius: 10px; border: 2px solid #e0e0e0;">
                        <h3 style="margin-top: 0; margin-bottom: 15px;">
                            <i class="fab fa-telegram" style="color: #0088cc;"></i>
                            –ü—Ä–∏–≤—è–∑–∫–∞ Telegram
                        </h3>
                        <div id="telegram-status-container">
                            <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å—Ç–∞—Ç—É—Å Telegram -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label>–ü–æ–ª–Ω–æ–µ –∏–º—è:</label>
                        <input type="text" id="profile-fullname" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á">
                    </div>

                    <div class="form-group">
                        <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                        <input type="tel" id="profile-phone" placeholder="+7 (999) 123-45-67">
                    </div>

                    <div class="form-group">
                        <label>–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞:</label>
                        <select id="profile-vehicle">
                            <option value="car">üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å</option>
                            <option value="bike">üö≤ –í–µ–ª–æ—Å–∏–ø–µ–¥</option>
                            <option value="foot">üö∂ –ü–µ—à–∫–æ–º</option>
                            <option value="motorcycle">üèçÔ∏è –ú–æ—Ç–æ—Ü–∏–∫–ª</option>
                        </select>
                    </div>

                    <button class="btn" id="save-profile-btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>

                    <hr style="margin: 30px 0; border: none; border-top: 2px solid #eee;">

                    <h3 style="margin-bottom: 20px;">üîí –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>

                    <div class="form-group">
                        <label>–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="current-password" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å">
                    </div>

                    <div class="form-group">
                        <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="new-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)">
                    </div>

                    <div class="form-group">
                        <label>–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="confirm-password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                    </div>

                    <button class="btn" id="change-password-btn">üîê –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>

                    <button class="btn logout-btn" id="logout-btn">üö™ –í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞ -->
    <div id="order-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì¶ –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ #<span id="modal-order-id"></span></h2>
                <button class="modal-close" id="close-modal">√ó</button>
            </div>
            <div id="modal-content-body">
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ Telegram -->
    <div id="telegram-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fab fa-telegram" style="color: #0088cc;"></i> –ü—Ä–∏–≤—è–∑–∫–∞ Telegram</h2>
                <button class="modal-close" id="close-telegram-modal">√ó</button>
            </div>
            <div id="telegram-modal-content">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>

    <script>
        class CourierApp {
            constructor() {
                this.currentCourier = null;
                this.currentToken = null;
                this.currentOrderId = null;
                this.currentPhoto = null;
                this.init();
            }

            async init() {
                console.log('üöö –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫—É—Ä—å–µ—Ä—Å–∫–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
                this.bindEvents();
                this.checkSavedSession();
            }

            bindEvents() {
                // –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞
                document.getElementById('login-button').addEventListener('click', () => this.login());

                // –ö–Ω–æ–ø–∫–∏ –≤–∫–ª–∞–¥–æ–∫
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const tabName = e.currentTarget.dataset.tab;
                        this.showTab(tabName);
                    });
                });

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
                document.getElementById('refresh-available').addEventListener('click', () => this.loadAvailableOrders());

                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
                document.getElementById('save-profile-btn').addEventListener('click', () => this.saveProfile());

                // –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è
                document.getElementById('change-password-btn').addEventListener('click', () => this.changePassword());

                // –í—ã—Ö–æ–¥
                document.getElementById('logout-btn').addEventListener('click', () => this.logout());

                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
                document.getElementById('close-modal').addEventListener('click', () => this.closeModal());
                document.getElementById('close-telegram-modal').addEventListener('click', () => this.closeTelegramModal());

                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            if (modal.id === 'order-modal') this.closeModal();
                            if (modal.id === 'telegram-modal') this.closeTelegramModal();
                        }
                    });
                });

                // ESC –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeModal();
                        this.closeTelegramModal();
                    }
                });
            }

            checkSavedSession() {
                const savedData = localStorage.getItem('courier_data');
                if (savedData) {
                    try {
                        const data = JSON.parse(savedData);
                        this.currentCourier = data.courier;
                        this.currentToken = data.token;
                        this.showCourierInterface();
                        this.updateCourierInfo();
                        this.loadAvailableOrders();
                        this.loadActiveOrders();
                        this.loadStatistics();
                        this.loadTelegramStatus();
                    } catch (e) {
                        localStorage.removeItem('courier_data');
                        this.showLogin();
                    }
                } else {
                    this.showLogin();
                }
            }

            showLogin() {
                document.getElementById('login-screen').style.display = 'block';
                document.getElementById('main-screen').style.display = 'none';
            }

            showCourierInterface() {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-screen').style.display = 'block';
            }

            async login() {
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                const errorDiv = document.getElementById('login-error');

                if (!username || !password) {
                    errorDiv.textContent = '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å';
                    errorDiv.style.display = 'block';
                    return;
                }

                try {
                    const response = await fetch('/api/courier/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.currentCourier = data.courier;
                        this.currentToken = data.token;

                        localStorage.setItem('courier_data', JSON.stringify({
                            courier: this.currentCourier,
                            token: this.currentToken
                        }));

                        this.showCourierInterface();
                        this.updateCourierInfo();
                        this.loadAvailableOrders();
                        this.loadActiveOrders();
                        this.loadStatistics();
                        this.loadTelegramStatus();

                    } else {
                        errorDiv.textContent = data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
                        errorDiv.style.display = 'block';
                    }
                } catch (error) {
                    errorDiv.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
                    errorDiv.style.display = 'block';
                    console.error('Login error:', error);
                }
            }

            updateCourierInfo() {
                if (this.currentCourier) {
                    document.getElementById('courier-info').textContent =
                        `${this.currentCourier.full_name} ‚Ä¢ ${this.currentCourier.phone}`;

                    document.getElementById('profile-username').textContent = this.currentCourier.username;
                    document.getElementById('profile-id').textContent = this.currentCourier.id;
                    document.getElementById('profile-created').textContent =
                        new Date(this.currentCourier.created_at).toLocaleDateString('ru-RU');
                    document.getElementById('profile-fullname').value = this.currentCourier.full_name || '';
                    document.getElementById('profile-phone').value = this.currentCourier.phone || '';
                    document.getElementById('profile-vehicle').value = this.currentCourier.vehicle_type || 'car';
                }
            }

            showTab(tabName) {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
                document.getElementById(`tab-${tabName}`).classList.add('active');

                switch(tabName) {
                    case 'available':
                        this.loadAvailableOrders();
                        break;
                    case 'orders':
                        this.loadActiveOrders();
                        break;
                    case 'completed':
                        this.loadCompletedOrders();
                        break;
                    case 'stats':
                        this.loadStatistics();
                        break;
                    case 'settings':
                        this.loadTelegramStatus();
                        break;
                }
            }

            async loadAvailableOrders() {
                const container = document.getElementById('available-orders-list');
                container.innerHTML = '<div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤...</div>';

                try {
                    const response = await fetch('/api/courier/available-orders');
                    const data = await response.json();

                    if (data.success && data.available_orders.length > 0) {
                        let html = '';
                        data.available_orders.forEach(order => {
                            const deliveryInfo = this.extractDeliveryInfo(order);
                            const total = order.total_price || 0;
                            const deliveryCost = order.delivery_cost || 0;
                            const totalWithDelivery = order.total_with_delivery || (total + deliveryCost);

                            html += `
                                <div class="order-card available">
                                    <div class="order-header">
                                        <div class="order-id">–ó–∞–∫–∞–∑ #${order.id}</div>
                                        <div class="order-reward">
                                            <i class="fas fa-money-bill-wave"></i>
                                            ${totalWithDelivery} ‚ÇΩ
                                        </div>
                                    </div>

                                    <div class="order-info">
                                        <div class="info-item">
                                            <span class="info-label">–¢–æ–≤–∞—Ä—ã:</span>
                                            <span class="info-value">${total} ‚ÇΩ</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">–î–æ—Å—Ç–∞–≤–∫–∞:</span>
                                            <span class="info-value" style="${deliveryCost > 0 ? '' : 'color: #27ae60;'}">
                                                ${deliveryCost > 0 ? `${deliveryCost} ‚ÇΩ` : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'}
                                            </span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</span>
                                            <span class="info-value">${deliveryInfo.recipient}</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                                            <span class="info-value">${deliveryInfo.phone}</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">–ê–¥—Ä–µ—Å:</span>
                                            <span class="info-value" style="font-size: 12px;">${deliveryInfo.address}</span>
                                        </div>
                                        ${deliveryInfo.details.length > 0 ? `
                                            <div class="info-item">
                                                <span class="info-label">–î–µ—Ç–∞–ª–∏:</span>
                                                <span class="info-value" style="font-size: 11px; color: #666;">
                                                    ${deliveryInfo.details.join(', ')}
                                                </span>
                                            </div>
                                        ` : ''}
                                        <div class="info-item">
                                            <span class="info-label">–°–æ–∑–¥–∞–Ω:</span>
                                            <span class="info-value">${new Date(order.created_at).toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}</span>
                                        </div>
                                    </div>

                                    <div class="order-actions">
                                        <button class="btn-action btn-take-order" onclick="courierApp.takeOrder(${order.id})">
                                            üëã –í–∑—è—Ç—å –∑–∞–∫–∞–∑
                                        </button>
                                        <button class="btn-action btn-details" onclick="courierApp.showOrderDetails(${order.id})">
                                            üìã –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<div class="loader">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>';
                    }
                } catch (error) {
                    container.innerHTML = '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>';
                    console.error('Error loading available orders:', error);
                }
            }

            async takeOrder(orderId) {
                if (!this.currentCourier) {
                    alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                    return;
                }

                if (confirm(`–í–∑—è—Ç—å –∑–∞–∫–∞–∑ #${orderId} –≤ –¥–æ—Å—Ç–∞–≤–∫—É?`)) {
                    try {
                        const response = await fetch('/api/courier/take-order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                order_id: orderId,
                                courier_id: this.currentCourier.id
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            alert(`‚úÖ –ó–∞–∫–∞–∑ #${orderId} –≤–∑—è—Ç –≤ –¥–æ—Å—Ç–∞–≤–∫—É!`);
                            this.loadAvailableOrders();
                            this.loadActiveOrders();
                            this.loadStatistics();
                        } else {
                            throw new Error(data.error || '–û—à–∏–±–∫–∞ –≤–∑—è—Ç–∏—è –∑–∞–∫–∞–∑–∞');
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –≤–∑—è—Ç–∏—è –∑–∞–∫–∞–∑–∞:', error);
                        alert(`‚ùå ${error.message}`);
                    }
                }
            }

            extractDeliveryInfo(order) {
                let address = "–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω";
                let details = [];
                let recipient = order.recipient_name || order.username || "–ù–µ —É–∫–∞–∑–∞–Ω";
                let phone = order.phone_number || "–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω";

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º delivery_address_obj
                if (order.delivery_address_obj && typeof order.delivery_address_obj === 'object') {
                    const addr = order.delivery_address_obj;

                    // –û—Å–Ω–æ–≤–Ω—ã–µ —á–∞—Å—Ç–∏ –∞–¥—Ä–µ—Å–∞
                    const mainParts = [];
                    if (addr.city) mainParts.push(addr.city);
                    if (addr.street) mainParts.push(`—É–ª. ${addr.street}`);
                    if (addr.house) mainParts.push(`–¥. ${addr.house}`);
                    if (addr.building) mainParts.push(`–∫–æ—Ä–ø. ${addr.building}`);

                    if (mainParts.length > 0) {
                        address = mainParts.join(', ');
                    }

                    // –î–µ—Ç–∞–ª–∏ –∞–¥—Ä–µ—Å–∞
                    if (addr.entrance && addr.entrance.trim()) details.push(`–ü–æ–¥—ä–µ–∑–¥: ${addr.entrance}`);
                    if (addr.floor && addr.floor.trim()) details.push(`–≠—Ç–∞–∂: ${addr.floor}`);
                    if (addr.apartment && addr.apartment.trim()) details.push(`–ö–≤–∞—Ä—Ç–∏—Ä–∞: ${addr.apartment}`);
                    if (addr.doorcode && addr.doorcode.trim()) details.push(`–î–æ–º–æ—Ñ–æ–Ω: ${addr.doorcode}`);
                    if (addr.comment && addr.comment.trim()) details.push(`–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${addr.comment}`);

                    if (recipient === "–ù–µ —É–∫–∞–∑–∞–Ω" && addr.recipient_name) {
                        recipient = addr.recipient_name;
                    }

                    if (phone === "–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω" && addr.phone) {
                        phone = addr.phone;
                    }
                }
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º delivery_address –∫–∞–∫ JSON —Å—Ç—Ä–æ–∫—É
                else if (order.delivery_address && typeof order.delivery_address === 'string') {
                    try {
                        const addr = JSON.parse(order.delivery_address);
                        const mainParts = [];
                        if (addr.city) mainParts.push(addr.city);
                        if (addr.street) mainParts.push(`—É–ª. ${addr.street}`);
                        if (addr.house) mainParts.push(`–¥. ${addr.house}`);
                        if (addr.building) mainParts.push(`–∫–æ—Ä–ø. ${addr.building}`);

                        if (mainParts.length > 0) {
                            address = mainParts.join(', ');
                        }

                        if (addr.entrance && addr.entrance.trim()) details.push(`–ü–æ–¥—ä–µ–∑–¥: ${addr.entrance}`);
                        if (addr.floor && addr.floor.trim()) details.push(`–≠—Ç–∞–∂: ${addr.floor}`);
                        if (addr.apartment && addr.apartment.trim()) details.push(`–ö–≤–∞—Ä—Ç–∏—Ä–∞: ${addr.apartment}`);
                        if (addr.doorcode && addr.doorcode.trim()) details.push(`–î–æ–º–æ—Ñ–æ–Ω: ${addr.doorcode}`);
                        if (addr.comment && addr.comment.trim()) details.push(`–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${addr.comment}`);

                        if (recipient === "–ù–µ —É–∫–∞–∑–∞–Ω" && addr.recipient_name) {
                            recipient = addr.recipient_name;
                        }

                        if (phone === "–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω" && addr.phone) {
                            phone = addr.phone;
                        }
                    } catch (e) {
                        address = order.delivery_address;
                    }
                }
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Å—Ç–æ —Å—Ç—Ä–æ–∫—É
                else if (order.delivery_address) {
                    address = order.delivery_address;
                }

                return {
                    address,
                    details,
                    recipient,
                    phone
                };
            }

            async loadActiveOrders() {
                const container = document.getElementById('active-orders-list');
                container.innerHTML = '<div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>';

                try {
                    const response = await fetch(`/api/courier/orders?courier_id=${this.currentCourier.id}`);
                    const data = await response.json();

                    if (data.success && data.active_orders.length > 0) {
                        let html = '';
                        data.active_orders.forEach(order => {
                            const assignment = order.assignment_status || 'assigned';
                            const deliveryInfo = this.extractDeliveryInfo(order);
                            let itemsCount = 0;
                            if (order.items_list && Array.isArray(order.items_list)) {
                                itemsCount = order.items_list.length;
                            }

                            html += `
                                <div class="order-card">
                                    <div class="order-header">
                                        <div class="order-id">–ó–∞–∫–∞–∑ #${order.id}</div>
                                        <div class="order-status status-${assignment}">
                                            ${this.getStatusText(assignment)}
                                        </div>
                                    </div>

                                    <div class="order-info">
                                        <div class="info-item">
                                            <span class="info-label">–°—É–º–º–∞:</span>
                                            <span class="info-value">${order.total_price || 0} ‚ÇΩ</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</span>
                                            <span class="info-value">${deliveryInfo.recipient}</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                                            <span class="info-value">${deliveryInfo.phone}</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">–ê–¥—Ä–µ—Å:</span>
                                            <span class="info-value" style="font-size: 12px;">${deliveryInfo.address}</span>
                                        </div>
                                        ${deliveryInfo.details.length > 0 ? `
                                            <div class="info-item">
                                                <span class="info-label">–î–µ—Ç–∞–ª–∏:</span>
                                                <span class="info-value" style="font-size: 11px; color: #666;">
                                                    ${deliveryInfo.details.join(', ')}
                                                </span>
                                            </div>
                                        ` : ''}
                                        <div class="info-item">
                                            <span class="info-label">–¢–æ–≤–∞—Ä–æ–≤:</span>
                                            <span class="info-value">${itemsCount} —à—Ç.</span>
                                        </div>
                                    </div>

                                    <div class="order-actions">
                                        <button class="btn-action btn-details" onclick="courierApp.showOrderDetails(${order.id})">
                                            üìã –î–µ—Ç–∞–ª–∏
                                        </button>
                                        ${assignment === 'assigned' ? `
                                            <button class="btn-action btn-pickup" onclick="courierApp.updateOrderStatus(${order.id}, 'picked_up')">
                                                üöö –í–∑—è—Ç—å –≤ –¥–æ—Å—Ç–∞–≤–∫—É
                                            </button>
                                        ` : ''}
                                        ${assignment === 'picked_up' ? `
                                            <button class="btn-action btn-deliver" onclick="courierApp.showDeliveryForm(${order.id})">
                                                ‚úÖ –î–æ—Å—Ç–∞–≤–∏—Ç—å
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        });
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<div class="loader">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>';
                    }
                } catch (error) {
                    container.innerHTML = '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</div>';
                    console.error('Error loading orders:', error);
                }
            }

            async showOrderDetails(orderId) {
                try {
                    const response = await fetch(`/api/courier/order/${orderId}`);
                    const data = await response.json();

                    if (data.success) {
                        const order = data.order;
                        const items = order.items_list || [];
                        const total = parseFloat(order.total_price) || 0;
                        const deliveryCost = parseFloat(order.delivery_cost) || 0;
                        const totalWithDelivery = total + deliveryCost;
                        const deliveryInfo = this.extractDeliveryInfo(order);

                        let html = `
                            <div class="order-details">
                                <div class="section">
                                    <h3>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ</h3>
                                    <div class="info-grid">
                                        <div><strong>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</strong> #${order.id}</div>
                                        <div><strong>–°—Ç–∞—Ç—É—Å:</strong> ${this.getStatusText(order.status || order.assignment_status)}</div>
                                        <div><strong>–¢–æ–≤–∞—Ä—ã:</strong> ${this.formatPrice(total)} ‚ÇΩ</div>
                                        <div><strong>–î–æ—Å—Ç–∞–≤–∫–∞:</strong> ${deliveryCost > 0 ? deliveryCost + ' ‚ÇΩ' : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'}</div>
                                        <div><strong>–ò—Ç–æ–≥–æ:</strong> <strong>${this.formatPrice(totalWithDelivery)} ‚ÇΩ</strong></div>
                                        <div><strong>–¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏:</strong> ${order.delivery_type === 'courier' ? '–ö—É—Ä—å–µ—Ä' : '–°–∞–º–æ–≤—ã–≤–æ–∑'}</div>
                                        <div><strong>–û–ø–ª–∞—Ç–∞:</strong> ${order.payment_method === 'cash' ? '–ù–∞–ª–∏—á–Ω—ã–µ' : order.payment_method === 'transfer' ? '–ü–µ—Ä–µ–≤–æ–¥' : '–¢–µ—Ä–º–∏–Ω–∞–ª'}</div>
                                        <div><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> ${new Date(order.created_at).toLocaleString('ru-RU')}</div>
                                    </div>
                                </div>

                                <div class="section">
                                    <h3>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h3>
                                    <div class="info-grid">
                                        <div><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> ${deliveryInfo.recipient}</div>
                                        <div><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${deliveryInfo.phone}</div>
                                        ${order.username ? `<div><strong>Username:</strong> @${order.username}</div>` : ''}
                                    </div>
                                </div>

                                <div class="section">
                                    <h3>üìç –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
                                    <div class="info-grid">
                                        <div><strong>–ê–¥—Ä–µ—Å:</strong> ${deliveryInfo.address}</div>
                                        ${deliveryInfo.details.length > 0 ? `
                                            <div><strong>–î–µ—Ç–∞–ª–∏ –∞–¥—Ä–µ—Å–∞:</strong></div>
                                            <div style="grid-column: 1 / -1;">
                                                ${deliveryInfo.details.map(detail => `<div class="address-detail">‚Ä¢ ${detail}</div>`).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                        `;

                        if (items.length > 0) {
                            html += `
                                <div class="section">
                                    <h3>üõçÔ∏è –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞</h3>
                                    <div class="items-list">
                                        ${items.map(item => {
                                            const itemPrice = parseFloat(item.price) || 0;
                                            const itemQuantity = parseInt(item.quantity) || 1;
                                            const itemTotal = itemPrice * itemQuantity;
                                            return `
                                                <div class="item">
                                                    <div class="item-name">${item.name || '–¢–æ–≤–∞—Ä'}</div>
                                                    <div class="item-quantity">${itemQuantity} √ó ${this.formatPrice(itemPrice)} ‚ÇΩ</div>
                                                    <div class="item-total">${this.formatPrice(itemTotal)} ‚ÇΩ</div>
                                                </div>
                                            `;
                                        }).join('')}
                                        <div class="item-total-row">
                                            <div><strong>–ò—Ç–æ–≥–æ:</strong></div>
                                            <div></div>
                                            <div><strong>${this.formatPrice(totalWithDelivery)} ‚ÇΩ</strong></div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }

                        if (order.delivery_notes) {
                            html += `
                                <div class="section">
                                    <h3>üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞</h3>
                                    <div class="notes">${order.delivery_notes}</div>
                                </div>
                            `;
                        }

                        html += `</div>`;

                        document.getElementById('modal-order-id').textContent = orderId;
                        document.getElementById('modal-content-body').innerHTML = html;
                        document.getElementById('order-modal').style.display = 'flex';
                    } else {
                        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞');
                    }
                } catch (error) {
                    console.error('Error loading order details:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞');
                }
            }

            async updateOrderStatus(orderId, status) {
                try {
                    const response = await fetch('/api/courier/update-status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            order_id: orderId,
                            courier_id: this.currentCourier.id,
                            status: status
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        alert(`–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ #${orderId} –æ–±–Ω–æ–≤–ª–µ–Ω`);
                        this.loadActiveOrders();
                        this.loadStatistics();
                    } else {
                        alert(data.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                    }
                } catch (error) {
                    console.error('Error updating status:', error);
                    alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                }
            }

            logout() {
                if (confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                    localStorage.removeItem('courier_data');
                    this.currentCourier = null;
                    this.currentToken = null;
                    document.getElementById('login-screen').style.display = 'block';
                    document.getElementById('main-screen').style.display = 'none';
                    document.getElementById('login-username').value = '';
                    document.getElementById('login-password').value = '';
                }
            }

            closeModal() {
                document.getElementById('order-modal').style.display = 'none';
                this.currentPhoto = null;
                this.currentOrderId = null;
            }

            closeTelegramModal() {
                document.getElementById('telegram-modal').style.display = 'none';
            }

            getStatusText(status) {
                const statuses = {
                    'assigned': '–ù–∞–∑–Ω–∞—á–µ–Ω',
                    'picked_up': '–í –¥–æ—Å—Ç–∞–≤–∫–µ',
                    'delivered': '–î–æ—Å—Ç–∞–≤–ª–µ–Ω',
                    'pending': '–û–∂–∏–¥–∞–µ—Ç',
                    'processing': '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ'
                };
                return statuses[status] || status;
            }

            formatPrice(price) {
                return new Intl.NumberFormat('ru-RU').format(Math.round(price || 0));
            }

            // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã (loadCompletedOrders, loadStatistics, loadTelegramStatus, saveProfile, changePassword, showDeliveryForm –∏ —Ç.–¥.)
            // –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –æ–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –≤ –≤–∞—à–µ–º –∏—Å—Ö–æ–¥–Ω–æ–º –∫–æ–¥–µ
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        window.courierApp = new CourierApp();
    </script>
</body>
</html>