<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—É—Ä—å–µ—Ä—Å–∫–∞—è –ø–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/courier.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container" id="app">
        <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
        <div id="login-screen" class="login-form">
            <h2>üöö –í—Ö–æ–¥ –¥–ª—è –∫—É—Ä—å–µ—Ä–∞</h2>
            <div id="login-error" class="error-message" style="display: none;"></div>

            <div class="form-group">
                <label>–õ–æ–≥–∏–Ω:</label>
                <input type="text" id="login-username" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
            </div>

            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="login-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>

            <button class="btn" onclick="login()">–í–æ–π—Ç–∏</button>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
        <div id="main-screen" style="display: none;">
            <div class="header">
                <h1>üöö –ö—É—Ä—å–µ—Ä—Å–∫–∞—è –ø–∞–Ω–µ–ª—å</h1>
                <p id="courier-info">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="showTab('available')">üì¶ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã</div>
                <div class="tab" onclick="showTab('orders')">üöö –ú–æ–∏ –∑–∞–∫–∞–∑—ã</div>
                <div class="tab" onclick="showTab('completed')">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</div>
                <div class="tab" onclick="showTab('stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                <div class="tab" onclick="showTab('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>

            <!-- –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã -->
            <div id="tab-available" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üì¶ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h2>
                    <button class="btn-action" onclick="loadAvailableOrders()" style="background: #3498db; color: white;">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>

                <div id="available-orders-list" class="available-orders-grid">
                    <div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤...</div>
                </div>
            </div>

            <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã -->
            <div id="tab-orders" class="tab-content">
                <h2 style="margin-bottom: 20px;">üöö –ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
                <div id="active-orders-list" class="loader">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...
                </div>
            </div>

            <!-- –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã -->
            <div id="tab-completed" class="tab-content">
                <h2 style="margin-bottom: 20px;">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h2>
                <div id="completed-orders-list" class="loader">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div id="tab-stats" class="tab-content">
                <h2 style="margin-bottom: 20px;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-today">0</div>
                        <div class="stat-label">–ó–∞–∫–∞–∑–æ–≤ —Å–µ–≥–æ–¥–Ω—è</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-active">0</div>
                        <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-completed">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 15px 0;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
                <div id="recent-deliveries" class="loader">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
                </div>
            </div>

            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div id="tab-settings" class="tab-content">
                <h2 style="margin-bottom: 20px;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>

                <div id="settings-message"></div>

                <div class="profile-form">
                    <div class="profile-info">
                        <p><strong>–õ–æ–≥–∏–Ω:</strong> <span id="profile-username">-</span></p>
                        <p><strong>ID:</strong> <span id="profile-id">-</span></p>
                        <p><strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> <span id="profile-created">-</span></p>
                    </div>

                    <!-- –ë–ª–æ–∫ –ø—Ä–∏–≤—è–∑–∫–∏ Telegram -->
                    <div id="telegram-section" style="margin: 20px 0; padding: 15px; border-radius: 10px; border: 2px solid #e0e0e0;">
                        <h3 style="margin-top: 0; margin-bottom: 15px;">
                            <i class="fab fa-telegram" style="color: #0088cc;"></i>
                            –ü—Ä–∏–≤—è–∑–∫–∞ Telegram
                        </h3>
                        <div id="telegram-status-container">
                            <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å—Ç–∞—Ç—É—Å Telegram -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label>–ü–æ–ª–Ω–æ–µ –∏–º—è:</label>
                        <input type="text" id="profile-fullname" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á">
                    </div>

                    <div class="form-group">
                        <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                        <input type="tel" id="profile-phone" placeholder="+7 (999) 123-45-67">
                    </div>

                    <div class="form-group">
                        <label>–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞:</label>
                        <select id="profile-vehicle">
                            <option value="car">üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å</option>
                            <option value="bike">üö≤ –í–µ–ª–æ—Å–∏–ø–µ–¥</option>
                            <option value="foot">üö∂ –ü–µ—à–∫–æ–º</option>
                            <option value="motorcycle">üèçÔ∏è –ú–æ—Ç–æ—Ü–∏–∫–ª</option>
                        </select>
                    </div>

                    <button class="btn" onclick="saveProfile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>

                    <hr style="margin: 30px 0; border: none; border-top: 2px solid #eee;">

                    <h3 style="margin-bottom: 20px;">üîí –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>

                    <div class="form-group">
                        <label>–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="current-password" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å">
                    </div>

                    <div class="form-group">
                        <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="new-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)">
                    </div>

                    <div class="form-group">
                        <label>–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="confirm-password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                    </div>

                    <button class="btn" onclick="changePassword()">üîê –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>

                    <button class="btn logout-btn" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞ -->
    <div id="order-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 15px; padding: 30px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üì¶ –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ #<span id="modal-order-id"></span></h2>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">√ó</button>
            </div>

            <div id="modal-content">
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ Telegram -->
    <div id="telegram-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">
                    <i class="fab fa-telegram" style="color: #0088cc;"></i>
                    –ü—Ä–∏–≤—è–∑–∫–∞ Telegram
                </h2>
                <button onclick="closeTelegramModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">√ó</button>
            </div>

            <div id="telegram-modal-content">
                <div id="telegram-guide">
                    <h3 style="color: #0088cc; margin-bottom: 15px;">–ö–∞–∫ –Ω–∞–π—Ç–∏ —Å–≤–æ–π Telegram ID?</h3>

                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; margin-bottom: 10px; background: #e3f2fd; padding: 10px; border-radius: 8px;">
                            <div style="background: #0088cc; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold;">1</div>
                            <div>
                                <strong>–û—Ç–∫—Ä–æ–π—Ç–µ Telegram</strong><br>
                                <small>–ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –∏–ª–∏ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ</small>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; margin-bottom: 10px; background: #e3f2fd; padding: 10px; border-radius: 8px;">
                            <div style="background: #0088cc; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold;">2</div>
                            <div>
                                <strong>–ù–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞ @userinfobot</strong><br>
                                <small>–í–≤–µ–¥–∏—Ç–µ –≤ –ø–æ–∏—Å–∫–µ "userinfobot"</small>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; margin-bottom: 10px; background: #e3f2fd; padding: 10px; border-radius: 8px;">
                            <div style="background: #0088cc; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold;">3</div>
                            <div>
                                <strong>–ù–∞–ø–∏—à–∏—Ç–µ –µ–º—É /start</strong><br>
                                <small>–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É</small>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; background: #e3f2fd; padding: 10px; border-radius: 8px;">
                            <div style="background: #0088cc; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold;">4</div>
                            <div>
                                <strong>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–∞—à ID</strong><br>
                                <small>–ù–∞–π–¥–∏—Ç–µ "Your Telegram ID:"</small>
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center; margin: 20px 0;">
                        <img src="https://telegram.org/img/t_logo.png" alt="Telegram Logo" style="width: 80px; height: 80px; opacity: 0.7;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label for="telegram-id-input" style="display: block; margin-bottom: 8px; font-weight: bold;">
                            –í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID:
                        </label>
                        <input type="number" id="telegram-id-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1234567890"
                               style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 16px;">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            –¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –¥—Ä—É–≥–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
                        </small>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="bindTelegram()" style="flex: 1; background: #0088cc; color: white;">
                            <i class="fab fa-telegram"></i> –ü—Ä–∏–≤—è–∑–∞—Ç—å Telegram
                        </button>
                        <button class="btn" onclick="closeTelegramModal()" style="flex: 1; background: #e0e0e0;">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </div>

                <div id="telegram-success" style="display: none; text-align: center; padding: 20px;">
                    <div style="font-size: 48px; color: #4CAF50; margin-bottom: 15px;">
                        ‚úÖ
                    </div>
                    <h3 style="color: #4CAF50; margin-bottom: 10px;">Telegram —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω!</h3>
                    <p>–¢–µ–ø–µ—Ä—å –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–∞—Ö –ø—Ä—è–º–æ –≤ Telegram.</p>
                    <button class="btn" onclick="closeTelegramModal()" style="margin-top: 20px; background: #0088cc; color: white;">
                        –ü–æ–Ω—è—Ç–Ω–æ
                    </button>
                </div>

                <div id="telegram-error" style="display: none; text-align: center; padding: 20px;">
                    <div style="font-size: 48px; color: #f44336; margin-bottom: 15px;">
                        ‚ùå
                    </div>
                    <h3 style="color: #f44336; margin-bottom: 10px;" id="telegram-error-title">–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏</h3>
                    <p id="telegram-error-message"></p>
                    <button class="btn" onclick="showTelegramGuide()" style="margin-top: 20px; background: #f44336; color: white;">
                        –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentCourier = null;
        let currentToken = null;
        let currentOrderId = null;
        let currentPhoto = null;

        // –§—É–Ω–∫—Ü–∏—è –≤—Ö–æ–¥–∞
        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');

            if (!username || !password) {
                errorDiv.textContent = '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/api/courier/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    currentCourier = data.courier;
                    currentToken = data.token;

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                    localStorage.setItem('courier_data', JSON.stringify({
                        courier: currentCourier,
                        token: currentToken
                    }));

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-screen').style.display = 'block';

                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                    updateCourierInfo();
                    loadAvailableOrders();
                    loadActiveOrders();
                    loadStatistics();
                    loadTelegramStatus(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å Telegram

                } else {
                    errorDiv.textContent = data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
                errorDiv.style.display = 'block';
                console.error('Login error:', error);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', function() {
            const savedData = localStorage.getItem('courier_data');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    currentCourier = data.courier;
                    currentToken = data.token;

                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-screen').style.display = 'block';

                    updateCourierInfo();
                    loadAvailableOrders();
                    loadActiveOrders();
                    loadStatistics();
                    loadTelegramStatus(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å Telegram
                } catch (e) {
                    localStorage.removeItem('courier_data');
                }
            }
        });

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–∏–≤—è–∑–∫–∏ Telegram
        async function loadTelegramStatus() {
            if (!currentCourier) return;

            const container = document.getElementById('telegram-status-container');
            container.innerHTML = '<div style="text-align: center; padding: 10px; color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Telegram...</div>';

            try {
                const response = await fetch(`/api/courier/telegram/${currentCourier.id}`);
                const data = await response.json();

                if (data.success) {
                    const telegramInfo = data.telegram_info;

                    container.innerHTML = `
                        <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; border: 1px solid #c3e6cb;">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <i class="fab fa-telegram" style="font-size: 24px; color: #0088cc; margin-right: 10px;"></i>
                                <div>
                                    <strong>Telegram –ø—Ä–∏–≤—è–∑–∞–Ω</strong><br>
                                    <small style="color: #155724;">ID: ${telegramInfo.telegram_id}</small>
                                </div>
                            </div>
                            <p style="margin: 0; font-size: 14px;">
                                <i class="fas fa-bell"></i> –í—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–∞—Ö
                            </p>
                            <button class="btn-action" onclick="unbindTelegram()" style="margin-top: 10px; width: 100%; background: #f44336; color: white;">
                                <i class="fas fa-unlink"></i> –û—Ç–≤—è–∑–∞—Ç—å Telegram
                            </button>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7;">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <i class="fab fa-telegram" style="font-size: 24px; color: #ffc107; margin-right: 10px;"></i>
                                <div>
                                    <strong>Telegram –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω</strong><br>
                                    <small style="color: #856404;">–ü—Ä–∏–≤—è–∂–∏—Ç–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</small>
                                </div>
                            </div>
                            <p style="margin: 0 0 15px 0; font-size: 14px;">
                                –ü–æ—Å–ª–µ –ø—Ä–∏–≤—è–∑–∫–∏ –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–∞—Ö –ø—Ä—è–º–æ –≤ Telegram
                            </p>
                            <button class="btn-action" onclick="showTelegramModal()" style="width: 100%; background: #0088cc; color: white;">
                                <i class="fab fa-telegram"></i> –ü—Ä–∏–≤—è–∑–∞—Ç—å Telegram
                            </button>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ffc107; font-size: 12px; color: #856404;">
                                <i class="fas fa-info-circle"></i>
                                <strong>–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø—Ä–∏–≤—è–∑–∫–∏:</strong><br>
                                ‚Ä¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–∞—Ö<br>
                                ‚Ä¢ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –±—Ä–∞—Ç—å –∑–∞–∫–∞–∑—ã –∏–∑ –±–æ—Ç–∞<br>
                                ‚Ä¢ –ë—ã—Å—Ç—Ä–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading Telegram status:', error);
                container.innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb;">
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #dc3545; margin-right: 10px;"></i>
                            <div>
                                <strong>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞</strong><br>
                                <small style="color: #721c24;">–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å Telegram</small>
                            </div>
                        </div>
                        <button class="btn-action" onclick="loadTelegramStatus()" style="margin-top: 10px; width: 100%; background: #6c757d; color: white;">
                            <i class="fas fa-redo"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                        </button>
                    </div>
                `;
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≤—è–∑–∫–∏ Telegram
        function showTelegramModal() {
            document.getElementById('telegram-modal').style.display = 'flex';
            showTelegramGuide();
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ Telegram
        function closeTelegramModal() {
            document.getElementById('telegram-modal').style.display = 'none';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –ø—Ä–∏–≤—è–∑–∫–µ
        function showTelegramGuide() {
            document.getElementById('telegram-guide').style.display = 'block';
            document.getElementById('telegram-success').style.display = 'none';
            document.getElementById('telegram-error').style.display = 'none';
            document.getElementById('telegram-id-input').value = '';
        }

        // –ü—Ä–∏–≤—è–∑–∞—Ç—å Telegram ID
        async function bindTelegram() {
            const telegramId = document.getElementById('telegram-id-input').value.trim();

            if (!telegramId) {
                showTelegramError('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ Telegram ID');
                return;
            }

            if (isNaN(telegramId) || telegramId.length < 5) {
                showTelegramError('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Telegram ID (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)');
                return;
            }

            try {
                const response = await fetch('/api/courier/register-telegram', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        courier_id: currentCourier.id,
                        telegram_id: parseInt(telegramId),
                        username: currentCourier.username,
                        first_name: currentCourier.full_name,
                        last_name: ''
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    document.getElementById('telegram-guide').style.display = 'none';
                    document.getElementById('telegram-success').style.display = 'block';

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –ø—Ä–æ—Ñ–∏–ª–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        closeTelegramModal();
                        loadTelegramStatus();
                    }, 2000);
                } else {
                    showTelegramError('–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏', data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–≤—è–∑–∞—Ç—å Telegram');
                }
            } catch (error) {
                console.error('Error binding Telegram:', error);
                showTelegramError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        }

        // –û—Ç–≤—è–∑–∞—Ç—å Telegram
        async function unbindTelegram() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–≤—è–∑–∞—Ç—å Telegram? –í—ã –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.')) {
                return;
            }

            try {
                const response = await fetch(`/api/courier/telegram/${currentCourier.id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Telegram —É—Å–ø–µ—à–Ω–æ –æ—Ç–≤—è–∑–∞–Ω');
                    loadTelegramStatus();
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –æ—Ç–≤—è–∑–∫–∏');
                }
            } catch (error) {
                console.error('Error unbinding Telegram:', error);
                alert('‚ùå ' + error.message);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –ø—Ä–∏–≤—è–∑–∫–∏ Telegram
        function showTelegramError(title, message) {
            document.getElementById('telegram-guide').style.display = 'none';
            document.getElementById('telegram-error').style.display = 'block';
            document.getElementById('telegram-error-title').textContent = title;
            document.getElementById('telegram-error-message').textContent = message;
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫—É—Ä—å–µ—Ä–µ
        function updateCourierInfo() {
            if (currentCourier) {
                document.getElementById('courier-info').textContent =
                    `${currentCourier.full_name} ‚Ä¢ ${currentCourier.phone}`;

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
                document.getElementById('profile-username').textContent = currentCourier.username;
                document.getElementById('profile-id').textContent = currentCourier.id;
                document.getElementById('profile-created').textContent =
                    new Date(currentCourier.created_at).toLocaleDateString('ru-RU');
                document.getElementById('profile-fullname').value = currentCourier.full_name || '';
                document.getElementById('profile-phone').value = currentCourier.phone || '';
                document.getElementById('profile-vehicle').value = currentCourier.vehicle_type || 'car';
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤–∫–ª–∞–¥–∫—É
        function showTab(tabName) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.querySelector(`.tab[onclick*="${tabName}"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
            switch(tabName) {
                case 'available':
                    loadAvailableOrders();
                    break;
                case 'orders':
                    loadActiveOrders();
                    break;
                case 'completed':
                    loadCompletedOrders();
                    break;
                case 'stats':
                    loadStatistics();
                    break;
                case 'settings':
                    loadProfile();
                    loadTelegramStatus();
                    break;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã
        async function loadAvailableOrders() {
            const container = document.getElementById('available-orders-list');
            if (!container) return;

            container.innerHTML = '<div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤...</div>';

            try {
                const response = await fetch('/api/courier/available-orders');
                const data = await response.json();

                if (data.success && data.available_orders.length > 0) {
                    let html = '';

                    data.available_orders.forEach(order => {
                        const deliveryInfo = extractDeliveryInfo(order);

                        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—É–º–º—É —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π
                        const total = order.total_price || 0;
                        const deliveryCost = order.delivery_cost || 0;
                        const totalWithDelivery = order.total_with_delivery || (total + deliveryCost);

                        html += `
                            <div class="order-card available" data-order-id="${order.id}">
                                <div class="order-header">
                                    <div class="order-id">–ó–∞–∫–∞–∑ #${order.id}</div>
                                    <div class="order-reward">
                                        <i class="fas fa-money-bill-wave"></i>
                                        ${totalWithDelivery} ‚ÇΩ
                                    </div>
                                </div>

                                <div class="order-info">
                                    <div class="info-item">
                                        <span class="info-label">–¢–æ–≤–∞—Ä—ã:</span>
                                        <span class="info-value">${total} ‚ÇΩ</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">–î–æ—Å—Ç–∞–≤–∫–∞:</span>
                                        <span class="info-value" style="${deliveryCost > 0 ? '' : 'color: #27ae60;'}">
                                            ${deliveryCost > 0 ? `${deliveryCost} ‚ÇΩ` : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'}
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</span>
                                        <span class="info-value">${deliveryInfo.recipient}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                                        <span class="info-value">${deliveryInfo.phone}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">–ê–¥—Ä–µ—Å:</span>
                                        <span class="info-value" style="font-size: 12px;">${deliveryInfo.address}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">–°–æ–∑–¥–∞–Ω:</span>
                                        <span class="info-value">${new Date(order.created_at).toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}</span>
                                    </div>
                                </div>

                                <div class="order-actions">
                                    <button class="btn-action btn-take-order" onclick="takeOrder(${order.id})">
                                        üëã –í–∑—è—Ç—å –∑–∞–∫–∞–∑
                                    </button>
                                    <button class="btn-action btn-details" onclick="showOrderDetails(${order.id})">
                                        üìã –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                    </button>
                                </div>
                            </div>
                        `;
                    });

                    container.innerHTML = html;

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
                    const badge = document.querySelector('.tab[onclick*="available"] .nav-badge');
                    if (badge) {
                        badge.textContent = data.available_orders.length;
                        badge.style.display = data.available_orders.length > 0 ? 'flex' : 'none';
                    }

                } else {
                    container.innerHTML = '<div class="loader">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>';

                    // –°–∫—Ä—ã–≤–∞–µ–º –±–µ–π–¥–∂ –µ—Å–ª–∏ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤
                    const badge = document.querySelector('.tab[onclick*="available"] .nav-badge');
                    if (badge) badge.style.display = 'none';
                }
            } catch (error) {
                container.innerHTML = '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>';
                console.error('Error loading available orders:', error);
            }
        }

        // –í–∑—è—Ç—å –∑–∞–∫–∞–∑
        async function takeOrder(orderId) {
            if (!currentCourier) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
            }

            if (confirm(`–í–∑—è—Ç—å –∑–∞–∫–∞–∑ #${orderId} –≤ –¥–æ—Å—Ç–∞–≤–∫—É?`)) {
                try {
                    const response = await fetch('/api/courier/take-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            order_id: orderId,
                            courier_id: currentCourier.id
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert(`‚úÖ –ó–∞–∫–∞–∑ #${orderId} –≤–∑—è—Ç –≤ –¥–æ—Å—Ç–∞–≤–∫—É!`);

                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–∫–∏ –∑–∞–∫–∞–∑–æ–≤
                        loadAvailableOrders();
                        loadActiveOrders();
                        loadStatistics();
                    } else {
                        throw new Error(data.error || '–û—à–∏–±–∫–∞ –≤–∑—è—Ç–∏—è –∑–∞–∫–∞–∑–∞');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –≤–∑—è—Ç–∏—è –∑–∞–∫–∞–∑–∞:', error);
                    alert(`‚ùå ${error.message}`);
                }
            }
        }

        function extractDeliveryInfo(order) {
            console.log('üîç extractDeliveryInfo –≤—ã–∑–≤–∞–Ω–∞ —Å order:', order);

            let address = "–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω";
            let addressDetails = [];
            let recipient = order.recipient_name || order.username || "–ù–µ —É–∫–∞–∑–∞–Ω";
            let phone = order.phone_number || "–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω";

            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º delivery_address_obj
            if (order.delivery_address_obj && typeof order.delivery_address_obj === 'object') {
                console.log('üìå –ò—Å–ø–æ–ª—å–∑—É–µ–º delivery_address_obj:', order.delivery_address_obj);
                const addr = order.delivery_address_obj;

                // –û—Å–Ω–æ–≤–Ω—ã–µ —á–∞—Å—Ç–∏ –∞–¥—Ä–µ—Å–∞
                const mainParts = [];
                if (addr.city) mainParts.push(addr.city);
                if (addr.street) mainParts.push(`—É–ª. ${addr.street}`);
                if (addr.house) mainParts.push(`–¥. ${addr.house}`);
                if (addr.building) mainParts.push(`–∫–æ—Ä–ø. ${addr.building}`);

                if (mainParts.length > 0) {
                    address = mainParts.join(', ');
                }

                // –î–µ—Ç–∞–ª–∏ –∞–¥—Ä–µ—Å–∞
                if (addr.entrance && addr.entrance.trim()) addressDetails.push(`–ü–æ–¥—ä–µ–∑–¥: ${addr.entrance}`);
                if (addr.floor && addr.floor.trim()) addressDetails.push(`–≠—Ç–∞–∂: ${addr.floor}`);
                if (addr.apartment && addr.apartment.trim()) addressDetails.push(`–ö–≤–∞—Ä—Ç–∏—Ä–∞: ${addr.apartment}`);
                if (addr.doorcode && addr.doorcode.trim()) addressDetails.push(`–î–æ–º–æ—Ñ–æ–Ω: ${addr.doorcode}`);
                if (addr.comment && addr.comment.trim()) addressDetails.push(`–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${addr.comment}`);

                if (recipient === "–ù–µ —É–∫–∞–∑–∞–Ω" && addr.recipient_name) {
                    recipient = addr.recipient_name;
                }

                if (phone === "–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω" && addr.phone) {
                    phone = addr.phone;
                }
            }
            // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º delivery_address –∫–∞–∫ JSON —Å—Ç—Ä–æ–∫—É
            else if (order.delivery_address && typeof order.delivery_address === 'string') {
                console.log('üìå –ü–∞—Ä—Å–∏–º delivery_address –∫–∞–∫ JSON:', order.delivery_address.substring(0, 100));
                try {
                    const addr = JSON.parse(order.delivery_address);
                    const mainParts = [];
                    if (addr.city) mainParts.push(addr.city);
                    if (addr.street) mainParts.push(`—É–ª. ${addr.street}`);
                    if (addr.house) mainParts.push(`–¥. ${addr.house}`);
                    if (addr.building) mainParts.push(`–∫–æ—Ä–ø. ${addr.building}`);

                    if (mainParts.length > 0) {
                        address = mainParts.join(', ');
                    }

                    if (addr.entrance && addr.entrance.trim()) addressDetails.push(`–ü–æ–¥—ä–µ–∑–¥: ${addr.entrance}`);
                    if (addr.floor && addr.floor.trim()) addressDetails.push(`–≠—Ç–∞–∂: ${addr.floor}`);
                    if (addr.apartment && addr.apartment.trim()) addressDetails.push(`–ö–≤–∞—Ä—Ç–∏—Ä–∞: ${addr.apartment}`);
                    if (addr.doorcode && addr.doorcode.trim()) addressDetails.push(`–î–æ–º–æ—Ñ–æ–Ω: ${addr.doorcode}`);
                    if (addr.comment && addr.comment.trim()) addressDetails.push(`–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${addr.comment}`);

                    if (recipient === "–ù–µ —É–∫–∞–∑–∞–Ω" && addr.recipient_name) {
                        recipient = addr.recipient_name;
                    }

                    if (phone === "–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω" && addr.phone) {
                        phone = addr.phone;
                    }
                } catch (e) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∞–¥—Ä–µ—Å–∞:', e);
                    address = order.delivery_address;
                }
            }
            // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Å—Ç–æ —Å—Ç—Ä–æ–∫—É
            else if (order.delivery_address) {
                console.log('üìå –ò—Å–ø–æ–ª—å–∑—É–µ–º delivery_address –∫–∞–∫ —Å—Ç—Ä–æ–∫—É:', order.delivery_address);
                address = order.delivery_address;
            }

            console.log('üìå –†–µ–∑—É–ª—å—Ç–∞—Ç extractDeliveryInfo:', { address, addressDetails, recipient, phone });
            return {
                address,
                addressDetails,
                recipient,
                phone
            };

            // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ –¥–æ—Å—Ç–∞–≤–∫–µ
            if (deliveryData) {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –∞–¥—Ä–µ—Å
                const parts = [];
                if (deliveryData.city) parts.push(deliveryData.city);
                if (deliveryData.street) parts.push(deliveryData.street);
                if (deliveryData.house) parts.push(deliveryData.house);

                if (parts.length > 0) {
                    addressText = parts.join(', ');
                    if (deliveryData.apartment) addressText += `, –∫–≤. ${deliveryData.apartment}`;
                } else if (deliveryData.address) {
                    addressText = deliveryData.address;
                }

                // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω
                if (deliveryData.recipient_name) {
                    recipientName = deliveryData.recipient_name;
                }
                if (deliveryData.phone) {
                    phoneNumber = deliveryData.phone;
                }
                if (deliveryData.phone_number) {
                    phoneNumber = deliveryData.phone_number;
                }
                if (deliveryData.recipient) {
                    recipientName = deliveryData.recipient;
                }
            }

            return {
                address: addressText,
                recipient: recipientName,
                phone: phoneNumber
            };
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã
        async function loadActiveOrders() {
            const container = document.getElementById('active-orders-list');
            container.innerHTML = '<div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>';

            try {
                const response = await fetch(`/api/courier/orders?courier_id=${currentCourier.id}`);
                const data = await response.json();

                if (data.success && data.active_orders.length > 0) {
                    let html = '';

                    data.active_orders.forEach(order => {
                        const assignment = order.assignment_status || 'assigned';

                        // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ—Å—Ç–∞–≤–∫–µ
                        const deliveryInfo = extractDeliveryInfo(order);

                        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–≤–∞—Ä—ã
                        let itemsCount = 0;
                        if (order.items_list && Array.isArray(order.items_list)) {
                            itemsCount = order.items_list.length;
                        } else if (order.items) {
                            try {
                                const items = JSON.parse(order.items);
                                itemsCount = items.length;
                            } catch (e) {
                                itemsCount = 0;
                            }
                        }

                        html += `
                            <div class="order-card">
                                <div class="order-header">
                                    <div class="order-id">–ó–∞–∫–∞–∑ #${order.id}</div>
                                    <div class="order-status status-${assignment}">
                                        ${getStatusText(assignment)}
                                    </div>
                                </div>

                                <div class="order-info">
                                    <div class="info-item">
                                        <span class="info-label">–°—É–º–º–∞:</span>
                                        <span class="info-value">${order.total_price || 0} ‚ÇΩ</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</span>
                                        <span class="info-value">${deliveryInfo.recipient}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                                        <span class="info-value">${deliveryInfo.phone}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">–ê–¥—Ä–µ—Å:</span>
                                        <span class="info-value" style="font-size: 12px;">${deliveryInfo.address}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">–¢–æ–≤–∞—Ä–æ–≤:</span>
                                        <span class="info-value">${itemsCount} —à—Ç.</span>
                                    </div>
                                </div>

                                <div class="order-actions">
                                    <button class="btn-action btn-details" onclick="showOrderDetails(${order.id})">
                                        üìã –î–µ—Ç–∞–ª–∏
                                    </button>

                                    ${assignment === 'assigned' ? `
                                        <button class="btn-action btn-pickup" onclick="updateOrderStatus(${order.id}, 'picked_up')">
                                            üöö –í–∑—è—Ç—å –≤ –¥–æ—Å—Ç–∞–≤–∫—É
                                        </button>
                                    ` : ''}

                                    ${assignment === 'picked_up' ? `
                                        <button class="btn-action btn-deliver" onclick="showDeliveryForm(${order.id})">
                                            ‚úÖ –î–æ—Å—Ç–∞–≤–∏—Ç—å
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });

                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="loader">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</div>';
                console.error('Error loading orders:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
        async function loadCompletedOrders() {
            const container = document.getElementById('completed-orders-list');
            container.innerHTML = '<div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>';

            try {
                const response = await fetch(`/api/courier/orders?courier_id=${currentCourier.id}`);
                const data = await response.json();

                if (data.success && data.completed_orders.length > 0) {
                    let html = '';

                    data.completed_orders.forEach(order => {
                        const deliveredDate = order.delivered_at ?
                            new Date(order.delivered_at).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞';

                        // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ—Å—Ç–∞–≤–∫–µ
                        const deliveryInfo = extractDeliveryInfo(order);

                        html += `
                            <div class="order-card">
                                <div class="order-header">
                                    <div class="order-id">–ó–∞–∫–∞–∑ #${order.id}</div>
                                    <div class="order-status status-delivered">–î–æ—Å—Ç–∞–≤–ª–µ–Ω</div>
                                </div>

                                <div class="order-info">
                                    <div class="info-item">
                                        <span class="info-label">–°—É–º–º–∞:</span>
                                        <span class="info-value">${order.total_price || 0} ‚ÇΩ</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:</span>
                                        <span class="info-value">${deliveredDate}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</span>
                                        <span class="info-value">${deliveryInfo.recipient}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                                        <span class="info-value">${deliveryInfo.phone}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">–ê–¥—Ä–µ—Å:</span>
                                        <span class="info-value" style="font-size: 12px;">${deliveryInfo.address}</span>
                                    </div>
                                </div>

                                <div class="order-actions">
                                    <button class="btn-action btn-details" onclick="showOrderDetails(${order.id})">
                                        üìã –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
                                    </button>
                                    ${order.photo_proof ? `
                                        <button class="btn-action" onclick="window.open('${order.photo_proof}', '_blank')">
                                            üì∑ –§–æ—Ç–æ
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });

                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="loader">–ù–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</div>';
                console.error('Error loading completed orders:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        async function loadStatistics() {
            try {
                const response = await fetch(`/api/courier/orders?courier_id=${currentCourier.id}`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('stat-active').textContent = data.active_orders?.length || 0;
                    document.getElementById('stat-completed').textContent = data.completed_orders?.length || 0;
                    document.getElementById('stat-today').textContent = data.today_orders?.length || 0;

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏
                    const recentDiv = document.getElementById('recent-deliveries');
                    if (data.completed_orders && data.completed_orders.length > 0) {
                        let html = '';
                        const recent = data.completed_orders.slice(0, 5);

                        recent.forEach(order => {
                            const date = order.delivered_at ?
                                new Date(order.delivered_at).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
                            const deliveryInfo = extractDeliveryInfo(order);

                            html += `
                                <div class="order-card" style="padding: 15px; margin-bottom: 10px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <div>
                                            <strong>–ó–∞–∫–∞–∑ #${order.id}</strong><br>
                                            <small>${deliveryInfo.recipient} ‚Ä¢ ${date}</small>
                                        </div>
                                        <div style="font-weight: bold;">${order.total_price || 0} ‚ÇΩ</div>
                                    </div>
                                </div>
                            `;
                        });

                        recentDiv.innerHTML = html;
                    } else {
                        recentDiv.innerHTML = '<div class="loader">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ—Å—Ç–∞–≤–∫–∞—Ö</div>';
                    }
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        async function loadProfile() {
            try {
                const response = await fetch(`/api/courier/profile?courier_id=${currentCourier.id}`);
                const data = await response.json();

                if (data.success) {
                    // –ü—Ä–æ—Ñ–∏–ª—å —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω –ø—Ä–∏ –≤—Ö–æ–¥–µ
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
        async function showOrderDetails(orderId) {
            try {
                const response = await fetch(`/api/courier/order/${orderId}`);
                const data = await response.json();

                if (data.success) {
                    const order = data.order;
                    const items = order.items_list || [];

                    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–ª–∏—á–Ω–æ–π –æ–ø–ª–∞—Ç–µ
                    const total = parseFloat(order.total_price) || 0;
                    const deliveryCost = parseFloat(order.delivery_cost) || 0;
                    const totalWithDelivery = total + deliveryCost;
                    const cashReceived = parseFloat(order.cash_received) || 0;
                    const cashChange = parseFloat(order.cash_change) || 0;
                    const cashToPay = totalWithDelivery;

                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ—Å—Ç–∞–≤–∫–µ
                    const deliveryInfo = extractDeliveryInfo(order);

                    let html = `
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px;">üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ</h3>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <p><strong>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</strong> #${order.id}</p>
                                <p><strong>–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞:</strong> ${getStatusText(order.status || order.assignment_status)}</p>
                                <p><strong>–°—É–º–º–∞ —Ç–æ–≤–∞—Ä–æ–≤:</strong> ${formatPrice(total)} ‚ÇΩ</p>
                                <p><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∞:</strong> ${deliveryCost > 0 ? deliveryCost + ' ‚ÇΩ' : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'}</p>
                                <p><strong>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</strong> <strong style="font-size: 16px;">${formatPrice(totalWithDelivery)} ‚ÇΩ</strong></p>
                                <p><strong>–¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏:</strong> ${order.delivery_type === 'courier' ? '–ö—É—Ä—å–µ—Ä' : '–°–∞–º–æ–≤—ã–≤–æ–∑'}</p>
                                <p><strong>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç–∞:</strong> ${order.payment_method === 'cash' ? '–ù–∞–ª–∏—á–Ω—ã–µ' :
                                                                      order.payment_method === 'transfer' ? '–ü–µ—Ä–µ–≤–æ–¥ –ø–æ –Ω–æ–º–µ—Ä—É' :
                                                                      order.payment_method === 'terminal' ? '–¢–µ—Ä–º–∏–Ω–∞–ª' : order.payment_method}</p>
                                <p><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> ${new Date(order.created_at).toLocaleString('ru-RU')}</p>
                            </div>
                        </div>
                    `;

                    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–ª–∏—á–Ω–æ–π –æ–ø–ª–∞—Ç–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                    if (order.payment_method === 'cash') {
                        if (cashReceived > 0 || cashChange > 0 || order.cash_details) {
                            let cashDetailsHtml = `
                                <div style="margin-bottom: 20px;">
                                    <h3 style="margin-bottom: 15px;">üíµ –ù–∞–ª–∏—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞</h3>
                                    <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold;">
                                            <span>–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                                            <span>${formatPrice(cashToPay)} ‚ÇΩ</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                            <span>–ü–æ–ª—É—á–µ–Ω–æ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:</span>
                                            <span style="color: #27ae60; font-weight: bold;">${formatPrice(cashReceived)} ‚ÇΩ</span>
                                        </div>
                            `;

                            if (cashChange > 0) {
                                cashDetailsHtml += `
                                    <div style="display: flex; justify-content: space-between; background: #dc3545; color: white; padding: 10px; border-radius: 6px; margin-top: 10px; font-weight: bold;">
                                        <span>‚ö†Ô∏è –°–¥–∞—á–∞ –∫–ª–∏–µ–Ω—Ç—É:</span>
                                        <span>${formatPrice(cashChange)} ‚ÇΩ</span>
                                    </div>
                                    <div style="font-size: 12px; color: #856404; margin-top: 8px; text-align: center;">
                                        <i class="fas fa-exclamation-triangle"></i> <strong>–í–ù–ò–ú–ê–ù–ò–ï: –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ —Å–¥–∞—á—É –∑–∞—Ä–∞–Ω–µ–µ!</strong>
                                    </div>
                                `;
                            } else if (cashChange === 0 && cashReceived >= cashToPay) {
                                cashDetailsHtml += `
                                    <div style="display: flex; justify-content: space-between; background: #28a745; color: white; padding: 10px; border-radius: 6px; margin-top: 10px;">
                                        <span>‚úÖ –ë–µ–∑ —Å–¥–∞—á–∏:</span>
                                        <span>–°–¥–∞—á–∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è</span>
                                    </div>
                                `;
                            } else if (cashReceived === 0) {
                                cashDetailsHtml += `
                                    <div style="display: flex; justify-content: space-between; background: #6c757d; color: white; padding: 10px; border-radius: 6px; margin-top: 10px;">
                                        <span>‚ö†Ô∏è –°—É–º–º–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞:</span>
                                        <span>–£—Ç–æ—á–Ω–∏—Ç–µ —Å—É–º–º—É —É –∫–ª–∏–µ–Ω—Ç–∞</span>
                                    </div>
                                `;
                            }

                            cashDetailsHtml += `</div></div>`;
                            html += cashDetailsHtml;
                        } else {
                            html += `
                                <div style="margin-bottom: 20px;">
                                    <h3 style="margin-bottom: 15px;">üíµ –ù–∞–ª–∏—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞</h3>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                        <div style="text-align: center; color: #6c757d;">
                                            <i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–ª–∏—á–Ω–æ–π –æ–ø–ª–∞—Ç–µ –±—É–¥–µ—Ç —É—Ç–æ—á–Ω–µ–Ω–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∞–≤–∫–µ
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    }

                    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ
                    html += `
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px;">üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h3>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <p><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> ${deliveryInfo.recipient}</p>
                                <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${deliveryInfo.phone}</p>
                                ${order.username ? `<p><strong>Username:</strong> @${order.username}</p>` : ''}
                            </div>
                        </div>
                    `;
                    if (deliveryInfo.address && deliveryInfo.address !== '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω') {
                    let addressHtml = `
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px;">üìç –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <p><strong>–ê–¥—Ä–µ—Å:</strong> ${deliveryInfo.address}</p>
                    `;

                    // –û–¢–õ–ê–î–ö–ê - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –º—ã –ø–æ–ª—É—á–∏–ª–∏
                    addressHtml += `
                        <div style="margin-top: 10px; padding: 10px; background: #ffd; border-radius: 6px; font-size: 12px;">
                            <strong>–û—Ç–ª–∞–¥–∫–∞:</strong> –ù–∞–π–¥–µ–Ω–æ ${deliveryInfo.addressDetails.length} –¥–µ—Ç–∞–ª–µ–π –∞–¥—Ä–µ—Å–∞<br>
                            ${deliveryInfo.addressDetails.join('<br>') || '–ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π'}
                        </div>
                    `;

                    // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ –∞–¥—Ä–µ—Å–∞, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                    if (deliveryInfo.addressDetails && deliveryInfo.addressDetails.length > 0) {
                        addressHtml += `
                            <div style="margin-top: 10px; padding: 10px; background: #e9ecef; border-radius: 6px; font-size: 14px;">
                                <strong style="color: #495057;">–î–µ—Ç–∞–ª–∏ –∞–¥—Ä–µ—Å–∞:</strong><br>
                        `;

                        deliveryInfo.addressDetails.forEach(detail => {
                            addressHtml += `<span style="display: inline-block; margin-right: 15px; margin-top: 5px;">‚Ä¢ ${detail}</span><br>`;
                        });

                        addressHtml += `</div>`;
                    }

                    addressHtml += `</div></div>`;
                    html += addressHtml;

                    // –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞
                    if (items.length > 0) {
                        let itemsTotal = 0;
                        html += `
                            <div style="margin-bottom: 20px;">
                                <h3 style="margin-bottom: 15px;">üõçÔ∏è –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞</h3>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    ${items.map(item => {
                                        const itemPrice = parseFloat(item.price) || 0;
                                        const itemQuantity = parseInt(item.quantity) || 1;
                                        const itemTotal = itemPrice * itemQuantity;
                                        itemsTotal += itemTotal;

                                        return `
                                            <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #dee2e6;">
                                                <div style="display: flex; justify-content: space-between;">
                                                    <div>
                                                        <strong>${item.name || '–¢–æ–≤–∞—Ä'}</strong><br>
                                                        <small>${itemQuantity} √ó ${formatPrice(itemPrice)} ‚ÇΩ</small>
                                                    </div>
                                                    <div style="font-weight: bold;">${formatPrice(itemTotal)} ‚ÇΩ</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #ddd;">
                                        <div style="display: flex; justify-content: space-between; font-weight: bold;">
                                            <div>–ò—Ç–æ–≥–æ:</div>
                                            <div>${formatPrice(totalWithDelivery)} ‚ÇΩ</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    // –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞
                    if (order.delivery_notes) {
                        html += `
                            <div style="margin-bottom: 20px;">
                                <h3 style="margin-bottom: 15px;">üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞</h3>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <p>${order.delivery_notes}</p>
                                </div>
                            </div>
                        `;
                    }

                    // –§–æ—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                    if (order.photo_proof) {
                        html += `
                            <div style="margin-bottom: 20px;">
                                <h3 style="margin-bottom: 15px;">üì∑ –§–æ—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</h3>
                                <div style="text-align: center;">
                                    <img src="${order.photo_proof}" alt="–§–æ—Ç–æ –¥–æ—Å—Ç–∞–≤–∫–∏" style="max-width: 100%; border-radius: 8px; border: 1px solid #ddd;">
                                </div>
                            </div>
                        `;
                    }

                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—É—Ä—å–µ—Ä–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                    if (order.courier_name || order.courier_phone) {
                        html += `
                            <div style="margin-bottom: 20px;">
                                <h3 style="margin-bottom: 15px;">üöö –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—É—Ä—å–µ—Ä–µ</h3>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    ${order.courier_name ? `<p><strong>–ö—É—Ä—å–µ—Ä:</strong> ${order.courier_name}</p>` : ''}
                                    ${order.courier_phone ? `<p><strong>–¢–µ–ª–µ—Ñ–æ–Ω –∫—É—Ä—å–µ—Ä–∞:</strong> ${order.courier_phone}</p>` : ''}
                                    ${order.assigned_at ? `<p><strong>–ù–∞–∑–Ω–∞—á–µ–Ω:</strong> ${new Date(order.assigned_at).toLocaleString('ru-RU')}</p>` : ''}
                                    ${order.delivered_at ? `<p><strong>–î–æ—Å—Ç–∞–≤–ª–µ–Ω:</strong> ${new Date(order.delivered_at).toLocaleString('ru-RU')}</p>` : ''}
                                </div>
                            </div>
                        `;
                    }

                    document.getElementById('modal-order-id').textContent = orderId;
                    document.getElementById('modal-content').innerHTML = html;
                    document.getElementById('order-modal').style.display = 'flex';
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('Error loading order details:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞');
            }
        z}

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–Ω—ã
        function formatPrice(price) {
            return new Intl.NumberFormat('ru-RU').format(Math.round(price || 0));
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
        async function updateOrderStatus(orderId, status) {
            try {
                const response = await fetch('/api/courier/update-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        order_id: orderId,
                        courier_id: currentCourier.id,
                        status: status
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ #${orderId} –æ–±–Ω–æ–≤–ª–µ–Ω`);
                    loadActiveOrders();
                    loadStatistics();
                } else {
                    alert(data.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –¥–æ—Å—Ç–∞–≤–∫–∏ —Å —Ñ–æ—Ç–æ
        async function showDeliveryForm(orderId) {
            currentOrderId = orderId;
            currentPhoto = null;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ
            try {
                const response = await fetch(`/api/courier/order/${orderId}`);
                const data = await response.json();

                if (data.success) {
                    const order = data.order;
                    const items = order.items_list || [];

                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ—Å—Ç–∞–≤–∫–µ
                    const deliveryInfo = extractDeliveryInfo(order);

                    let html = `
                        <div class="photo-upload">
                            <div style="margin-bottom: 20px;">
                                <h3 style="margin-bottom: 10px;">üì¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ #${order.id}</h3>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <p><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> ${deliveryInfo.recipient}</p>
                                    <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${deliveryInfo.phone}</p>
                                    <p><strong>–ê–¥—Ä–µ—Å:</strong> ${deliveryInfo.address}</p>
                                    <p><strong>–°—É–º–º–∞:</strong> ${order.total_price || 0} ‚ÇΩ</p>
                                </div>
                            </div>

                            <h4 style="margin-bottom: 15px;">üì∏ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏</h4>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px;">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∫ –¥–æ—Å—Ç–∞–≤–∫–µ:</label>
                                <textarea id="delivery-notes" style="width: 100%; padding: 10px; border-radius: 6px; border: 2px solid #e0e0e0;" rows="3" placeholder="–ö–ª–∏–µ–Ω—Ç –±—ã–ª –¥–æ–º–∞, –ø–µ—Ä–µ–¥–∞–ª –ª–∏—á–Ω–æ..."></textarea>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px;">–§–æ—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn-action" onclick="document.getElementById('cameraInput').click()" style="flex: 1;">
                                        üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ
                                    </button>
                                    <button class="btn-action" onclick="document.getElementById('galleryInput').click()" style="flex: 1;">
                                        üñºÔ∏è –í—ã–±—Ä–∞—Ç—å –∏–∑ –≥–∞–ª–µ—Ä–µ–∏
                                    </button>
                                </div>
                                <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
                                <input type="file" id="galleryInput" accept="image/*" style="display: none;">
                            </div>

                            <div id="photo-preview" class="photo-preview"></div>

                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn-action btn-deliver" onclick="completeDelivery()" id="confirmDeliveryBtn" disabled>
                                    ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É
                                </button>
                                <button class="btn-action" onclick="closeModal()">
                                    ‚ùå –û—Ç–º–µ–Ω–∞
                                </button>
                            </div>
                        </div>
                    `;

                    document.getElementById('modal-order-id').textContent = orderId;
                    document.getElementById('modal-content').innerHTML = html;
                    document.getElementById('order-modal').style.display = 'flex';

                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–æ—Ç–æ
                    document.getElementById('cameraInput').addEventListener('change', handlePhotoSelection);
                    document.getElementById('galleryInput').addEventListener('change', handlePhotoSelection);
                }
            } catch (error) {
                console.error('Error loading order for delivery:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–∫–∞–∑–µ');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ
        function handlePhotoSelection(e) {
            const file = e.target.files[0];
            if (!file) return;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
            if (!file.type.startsWith('image/')) {
                alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä (–º–∞–∫—Å 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 5MB)');
                return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                currentPhoto = {
                    data: e.target.result,
                    file: file
                };

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                const preview = document.getElementById('photo-preview');
                preview.innerHTML = `<img src="${e.target.result}" alt="–í—ã–±—Ä–∞–Ω–Ω–æ–µ —Ñ–æ—Ç–æ">`;
                preview.style.display = 'block';

                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                document.getElementById('confirmDeliveryBtn').disabled = false;
            };

            reader.readAsDataURL(file);
        }

        // –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É
        async function completeDelivery() {
            const notes = document.getElementById('delivery-notes').value;

            if (!currentPhoto) {
                alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏');
                return;
            }

            try {
                const response = await fetch('/api/courier/update-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        order_id: currentOrderId,
                        courier_id: currentCourier.id,
                        status: 'delivered',
                        photo_data: currentPhoto.data,
                        notes: notes
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ –ó–∞–∫–∞–∑ #${currentOrderId} —É—Å–ø–µ—à–Ω–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω!`);
                    closeModal();
                    loadActiveOrders();
                    loadCompletedOrders();
                    loadStatistics();

                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ç–æ
                    currentPhoto = null;
                    currentOrderId = null;
                } else {
                    alert(data.error || '–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏');
                }
            } catch (error) {
                console.error('Error completing delivery:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        async function saveProfile() {
            const fullName = document.getElementById('profile-fullname').value;
            const phone = document.getElementById('profile-phone').value;
            const vehicle = document.getElementById('profile-vehicle').value;

            if (!fullName || !phone) {
                showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            try {
                const response = await fetch('/api/courier/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        courier_id: currentCourier.id,
                        full_name: fullName,
                        phone: phone,
                        vehicle_type: vehicle
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
                    currentCourier = data.profile;
                    updateCourierInfo();
                } else {
                    showMessage(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è', 'error');
                }
            } catch (error) {
                console.error('Error saving profile:', error);
                showMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è', 'error');
            }
        }

        // –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
        async function changePassword() {
            const currentPass = document.getElementById('current-password').value;
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;

            if (!currentPass || !newPass || !confirmPass) {
                showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            if (newPass.length < 6) {
                showMessage('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                return;
            }

            if (newPass !== confirmPass) {
                showMessage('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
                return;
            }

            try {
                const response = await fetch('/api/courier/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        courier_id: currentCourier.id,
                        old_password: currentPass,
                        new_password: newPass
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω', 'success');
                    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';
                } else {
                    showMessage(data.error || '–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è', 'error');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showMessage('–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è', 'error');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(text, type) {
            const div = document.getElementById('settings-message');
            div.textContent = text;
            div.className = type + '-message';
            div.style.display = 'block';

            setTimeout(() => {
                div.style.display = 'none';
            }, 5000);
        }

        // –í—ã–π—Ç–∏
        function logout() {
            if (confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                localStorage.removeItem('courier_data');
                currentCourier = null;
                currentToken = null;

                document.getElementById('main-screen').style.display = 'none';
                document.getElementById('login-screen').style.display = 'block';

                // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –≤—Ö–æ–¥–∞
                document.getElementById('login-username').value = '';
                document.getElementById('login-password').value = '';
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function closeModal() {
            document.getElementById('order-modal').style.display = 'none';
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ç–æ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
            currentPhoto = null;
            currentOrderId = null;
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞
        function getStatusText(status) {
            const statuses = {
                'assigned': '–ù–∞–∑–Ω–∞—á–µ–Ω',
                'picked_up': '–í –¥–æ—Å—Ç–∞–≤–∫–µ',
                'delivered': '–î–æ—Å—Ç–∞–≤–ª–µ–Ω',
                'pending': '–û–∂–∏–¥–∞–µ—Ç',
                'processing': '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ'
            };
            return statuses[status] || status;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
        document.getElementById('order-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è Telegram –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        document.getElementById('telegram-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTelegramModal();
            }
        });
    </script>
</body>
</html>