<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—É—Ä—å–µ—Ä—Å–∫–∞—è –ø–∞–Ω–µ–ª—å</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f8f9ff;
        }

        .tab:hover {
            background: #f5f5f5;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-form {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px;
            width: 100%;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .order-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .order-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .order-id {
            font-weight: bold;
            color: #333;
            font-size: 18px;
        }

        .order-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-assigned { background: #fff3cd; color: #856404; }
        .status-picked_up { background: #d1ecf1; color: #0c5460; }
        .status-delivered { background: #d4edda; color: #155724; }

        .order-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .info-value {
            font-weight: 500;
            color: #333;
        }

        .order-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-pickup {
            background: #28a745;
            color: white;
        }

        .btn-deliver {
            background: #007bff;
            color: white;
        }

        .btn-details {
            background: #6c757d;
            color: white;
        }

        .btn-action:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .photo-upload {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #dee2e6;
            text-align: center;
        }

        .photo-preview {
            max-width: 300px;
            margin: 15px auto;
            display: none;
        }

        .photo-preview img {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .profile-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .profile-info {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .logout-btn {
            background: #dc3545;
            margin-top: 20px;
        }

        .loader {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header { padding: 20px; }
            .tab-content { padding: 20px; }
            .stats-grid { grid-template-columns: 1fr; }
            .order-info { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
        <div id="login-screen" class="login-form">
            <h2>üöö –í—Ö–æ–¥ –¥–ª—è –∫—É—Ä—å–µ—Ä–∞</h2>
            <div id="login-error" class="error-message" style="display: none;"></div>

            <div class="form-group">
                <label>–õ–æ–≥–∏–Ω:</label>
                <input type="text" id="login-username" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
            </div>

            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="login-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>

            <button class="btn" onclick="login()">–í–æ–π—Ç–∏</button>

            <div style="margin-top: 20px; text-align: center; color: #666;">
                <p>–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:</p>
                <p><strong>courier1</strong> / <strong>123456</strong></p>
                <p><strong>courier2</strong> / <strong>123456</strong></p>
                <p><strong>courier3</strong> / <strong>123456</strong></p>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
        <div id="main-screen" style="display: none;">
            <div class="header">
                <h1>üöö –ö—É—Ä—å–µ—Ä—Å–∫–∞—è –ø–∞–Ω–µ–ª—å</h1>
                <p id="courier-info">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="showTab('orders')">üì¶ –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã</div>
                <div class="tab" onclick="showTab('completed')">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</div>
                <div class="tab" onclick="showTab('stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                <div class="tab" onclick="showTab('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>

            <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã -->
            <div id="tab-orders" class="tab-content active">
                <h2 style="margin-bottom: 20px;">üì¶ –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h2>
                <div id="active-orders-list" class="loader">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...
                </div>
            </div>

            <!-- –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã -->
            <div id="tab-completed" class="tab-content">
                <h2 style="margin-bottom: 20px;">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h2>
                <div id="completed-orders-list" class="loader">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div id="tab-stats" class="tab-content">
                <h2 style="margin-bottom: 20px;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-today">0</div>
                        <div class="stat-label">–ó–∞–∫–∞–∑–æ–≤ —Å–µ–≥–æ–¥–Ω—è</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-active">0</div>
                        <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-completed">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 15px 0;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
                <div id="recent-deliveries" class="loader">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
                </div>
            </div>

            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div id="tab-settings" class="tab-content">
                <h2 style="margin-bottom: 20px;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>

                <div id="settings-message"></div>

                <div class="profile-form">
                    <div class="profile-info">
                        <p><strong>–õ–æ–≥–∏–Ω:</strong> <span id="profile-username">-</span></p>
                        <p><strong>ID:</strong> <span id="profile-id">-</span></p>
                        <p><strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> <span id="profile-created">-</span></p>
                    </div>

                    <div class="form-group">
                        <label>–ü–æ–ª–Ω–æ–µ –∏–º—è:</label>
                        <input type="text" id="profile-fullname" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á">
                    </div>

                    <div class="form-group">
                        <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                        <input type="tel" id="profile-phone" placeholder="+7 (999) 123-45-67">
                    </div>

                    <div class="form-group">
                        <label>–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞:</label>
                        <select id="profile-vehicle">
                            <option value="car">üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å</option>
                            <option value="bike">üö≤ –í–µ–ª–æ—Å–∏–ø–µ–¥</option>
                            <option value="foot">üö∂ –ü–µ—à–∫–æ–º</option>
                            <option value="motorcycle">üèçÔ∏è –ú–æ—Ç–æ—Ü–∏–∫–ª</option>
                        </select>
                    </div>

                    <button class="btn" onclick="saveProfile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>

                    <hr style="margin: 30px 0; border: none; border-top: 2px solid #eee;">

                    <h3 style="margin-bottom: 20px;">üîí –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>

                    <div class="form-group">
                        <label>–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="current-password" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å">
                    </div>

                    <div class="form-group">
                        <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="new-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)">
                    </div>

                    <div class="form-group">
                        <label>–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="confirm-password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                    </div>

                    <button class="btn" onclick="changePassword()">üîê –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>

                    <button class="btn logout-btn" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞ -->
    <div id="order-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 15px; padding: 30px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üì¶ –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ #<span id="modal-order-id"></span></h2>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">√ó</button>
            </div>

            <div id="modal-content">
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
        </div>
    </div>

    <script>
        let currentCourier = null;
        let currentToken = null;
        let currentOrderId = null;
        let currentPhoto = null;

        // –§—É–Ω–∫—Ü–∏—è –≤—Ö–æ–¥–∞
        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');

            if (!username || !password) {
                errorDiv.textContent = '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/api/courier/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    currentCourier = data.courier;
                    currentToken = data.token;

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                    localStorage.setItem('courier_data', JSON.stringify({
                        courier: currentCourier,
                        token: currentToken
                    }));

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-screen').style.display = 'block';

                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                    updateCourierInfo();
                    loadActiveOrders();
                    loadStatistics();

                } else {
                    errorDiv.textContent = data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
                errorDiv.style.display = 'block';
                console.error('Login error:', error);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', function() {
            const savedData = localStorage.getItem('courier_data');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    currentCourier = data.courier;
                    currentToken = data.token;

                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-screen').style.display = 'block';

                    updateCourierInfo();
                    loadActiveOrders();
                    loadStatistics();
                } catch (e) {
                    localStorage.removeItem('courier_data');
                }
            }
        });

        // –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫—É—Ä—å–µ—Ä–µ
        function updateCourierInfo() {
            if (currentCourier) {
                document.getElementById('courier-info').textContent =
                    `${currentCourier.full_name} ‚Ä¢ ${currentCourier.phone}`;

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
                document.getElementById('profile-username').textContent = currentCourier.username;
                document.getElementById('profile-id').textContent = currentCourier.id;
                document.getElementById('profile-created').textContent =
                    new Date(currentCourier.created_at).toLocaleDateString('ru-RU');
                document.getElementById('profile-fullname').value = currentCourier.full_name || '';
                document.getElementById('profile-phone').value = currentCourier.phone || '';
                document.getElementById('profile-vehicle').value = currentCourier.vehicle_type || 'car';
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤–∫–ª–∞–¥–∫—É
        function showTab(tabName) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.querySelector(`.tab[onclick*="${tabName}"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
            switch(tabName) {
                case 'orders':
                    loadActiveOrders();
                    break;
                case 'completed':
                    loadCompletedOrders();
                    break;
                case 'stats':
                    loadStatistics();
                    break;
                case 'settings':
                    loadProfile();
                    break;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã
        async function loadActiveOrders() {
            const container = document.getElementById('active-orders-list');
            container.innerHTML = '<div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>';

            try {
                const response = await fetch(`/api/courier/orders?courier_id=${currentCourier.id}`);
                const data = await response.json();

                if (data.success && data.active_orders.length > 0) {
                    let html = '';

                    data.active_orders.forEach(order => {
                        const assignment = order.assignment_status || 'assigned';

                        // –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–¥—Ä–µ—Å–µ
                        let addressText = '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω';
                        if (order.delivery_address_obj) {
                            const addr = order.delivery_address_obj;
                            if (addr.city || addr.street) {
                                addressText = `${addr.city || ''}, ${addr.street || ''} ${addr.house || ''}`;
                                if (addr.apartment) addressText += `, –∫–≤. ${addr.apartment}`;
                            }
                        } else if (order.delivery_address) {
                            try {
                                const addr = JSON.parse(order.delivery_address);
                                if (addr.city || addr.street) {
                                    addressText = `${addr.city || ''}, ${addr.street || ''} ${addr.house || ''}`;
                                    if (addr.apartment) addressText += `, –∫–≤. ${addr.apartment}`;
                                }
                            } catch (e) {
                                addressText = order.delivery_address;
                            }
                        }

                        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–≤–∞—Ä—ã
                        let itemsCount = 0;
                        if (order.items_list && Array.isArray(order.items_list)) {
                            itemsCount = order.items_list.length;
                        } else if (order.items) {
                            try {
                                const items = JSON.parse(order.items);
                                itemsCount = items.length;
                            } catch (e) {
                                itemsCount = 0;
                            }
                        }

                        html += `
                            <div class="order-card">
                                <div class="order-header">
                                    <div class="order-id">–ó–∞–∫–∞–∑ #${order.id}</div>
                                    <div class="order-status status-${assignment}">
                                        ${getStatusText(assignment)}
                                    </div>
                                </div>

                                <div class="order-info">
                                    <div class="info-item">
                                        <span class="info-label">–°—É–º–º–∞:</span>
                                        <span class="info-value">${order.total_price || 0} ‚ÇΩ</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</span>
                                        <span class="info-value">${order.recipient_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                                        <span class="info-value">${order.phone_number || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">–ê–¥—Ä–µ—Å:</span>
                                        <span class="info-value" style="font-size: 12px;">${addressText}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">–¢–æ–≤–∞—Ä–æ–≤:</span>
                                        <span class="info-value">${itemsCount} —à—Ç.</span>
                                    </div>
                                </div>

                                <div class="order-actions">
                                    <button class="btn-action btn-details" onclick="showOrderDetails(${order.id})">
                                        üìã –î–µ—Ç–∞–ª–∏
                                    </button>

                                    ${assignment === 'assigned' ? `
                                        <button class="btn-action btn-pickup" onclick="updateOrderStatus(${order.id}, 'picked_up')">
                                            üöö –í–∑—è—Ç—å –≤ –¥–æ—Å—Ç–∞–≤–∫—É
                                        </button>
                                    ` : ''}

                                    ${assignment === 'picked_up' ? `
                                        <button class="btn-action btn-deliver" onclick="showDeliveryForm(${order.id})">
                                            ‚úÖ –î–æ—Å—Ç–∞–≤–∏—Ç—å
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });

                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="loader">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</div>';
                console.error('Error loading orders:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
        async function loadCompletedOrders() {
            const container = document.getElementById('completed-orders-list');
            container.innerHTML = '<div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>';

            try {
                const response = await fetch(`/api/courier/orders?courier_id=${currentCourier.id}`);
                const data = await response.json();

                if (data.success && data.completed_orders.length > 0) {
                    let html = '';

                    data.completed_orders.forEach(order => {
                        const deliveredDate = order.delivered_at ?
                            new Date(order.delivered_at).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞';

                        // –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–¥—Ä–µ—Å–µ
                        let addressText = '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω';
                        if (order.delivery_address_obj) {
                            const addr = order.delivery_address_obj;
                            if (addr.city || addr.street) {
                                addressText = `${addr.city || ''}, ${addr.street || ''} ${addr.house || ''}`;
                            }
                        }

                        html += `
                            <div class="order-card">
                                <div class="order-header">
                                    <div class="order-id">–ó–∞–∫–∞–∑ #${order.id}</div>
                                    <div class="order-status status-delivered">–î–æ—Å—Ç–∞–≤–ª–µ–Ω</div>
                                </div>

                                <div class="order-info">
                                    <div class="info-item">
                                        <span class="info-label">–°—É–º–º–∞:</span>
                                        <span class="info-value">${order.total_price || 0} ‚ÇΩ</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:</span>
                                        <span class="info-value">${deliveredDate}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</span>
                                        <span class="info-value">${order.recipient_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">–ê–¥—Ä–µ—Å:</span>
                                        <span class="info-value" style="font-size: 12px;">${addressText}</span>
                                    </div>
                                </div>

                                <div class="order-actions">
                                    <button class="btn-action btn-details" onclick="showOrderDetails(${order.id})">
                                        üìã –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
                                    </button>
                                    ${order.photo_proof ? `
                                        <button class="btn-action" onclick="window.open('${order.photo_proof}', '_blank')">
                                            üì∑ –§–æ—Ç–æ
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });

                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="loader">–ù–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</div>';
                console.error('Error loading completed orders:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        async function loadStatistics() {
            try {
                const response = await fetch(`/api/courier/orders?courier_id=${currentCourier.id}`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('stat-active').textContent = data.active_orders?.length || 0;
                    document.getElementById('stat-completed').textContent = data.completed_orders?.length || 0;
                    document.getElementById('stat-today').textContent = data.today_orders?.length || 0;

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏
                    const recentDiv = document.getElementById('recent-deliveries');
                    if (data.completed_orders && data.completed_orders.length > 0) {
                        let html = '';
                        const recent = data.completed_orders.slice(0, 5);

                        recent.forEach(order => {
                            const date = order.delivered_at ?
                                new Date(order.delivered_at).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞';

                            html += `
                                <div class="order-card" style="padding: 15px; margin-bottom: 10px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <div>
                                            <strong>–ó–∞–∫–∞–∑ #${order.id}</strong><br>
                                            <small>${order.recipient_name || '–ù–µ —É–∫–∞–∑–∞–Ω'} ‚Ä¢ ${date}</small>
                                        </div>
                                        <div style="font-weight: bold;">${order.total_price || 0} ‚ÇΩ</div>
                                    </div>
                                </div>
                            `;
                        });

                        recentDiv.innerHTML = html;
                    } else {
                        recentDiv.innerHTML = '<div class="loader">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ—Å—Ç–∞–≤–∫–∞—Ö</div>';
                    }
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        async function loadProfile() {
            try {
                const response = await fetch(`/api/courier/profile?courier_id=${currentCourier.id}`);
                const data = await response.json();

                if (data.success) {
                    // –ü—Ä–æ—Ñ–∏–ª—å —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω –ø—Ä–∏ –≤—Ö–æ–¥–µ
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
        async function showOrderDetails(orderId) {
            try {
                const response = await fetch(`/api/courier/order/${orderId}`);
                const data = await response.json();

                if (data.success) {
                    const order = data.order;
                    const items = order.items_list || [];
                    const address = order.delivery_address_obj || {};

                    let html = `
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px;">üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ</h3>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <p><strong>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</strong> #${order.id}</p>
                                <p><strong>–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞:</strong> ${getStatusText(order.status || order.assignment_status)}</p>
                                <p><strong>–°—É–º–º–∞:</strong> ${order.total_price || 0} ‚ÇΩ</p>
                                <p><strong>–¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏:</strong> ${order.delivery_type === 'courier' ? '–ö—É—Ä—å–µ—Ä' : '–°–∞–º–æ–≤—ã–≤–æ–∑'}</p>
                                <p><strong>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</strong> ${order.payment_method === 'cash' ? '–ù–∞–ª–∏—á–Ω—ã–µ' : '–ü–µ—Ä–µ–≤–æ–¥'}</p>
                                <p><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> ${new Date(order.created_at).toLocaleString('ru-RU')}</p>
                            </div>
                        </div>
                    `;

                    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ
                    html += `
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px;">üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h3>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <p><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> ${order.recipient_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${order.phone_number || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                ${order.username ? `<p><strong>Username:</strong> @${order.username}</p>` : ''}
                            </div>
                        </div>
                    `;

                    if (address.city || address.street) {
                        html += `
                            <div style="margin-bottom: 20px;">
                                <h3 style="margin-bottom: 15px;">üìç –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <p><strong>–ì–æ—Ä–æ–¥:</strong> ${address.city || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                    <p><strong>–£–ª–∏—Ü–∞:</strong> ${address.street || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'} ${address.house || ''}</p>
                                    ${address.apartment ? `<p><strong>–ö–≤–∞—Ä—Ç–∏—Ä–∞:</strong> ${address.apartment}</p>` : ''}
                                    ${address.floor ? `<p><strong>–≠—Ç–∞–∂:</strong> ${address.floor}</p>` : ''}
                                    ${address.doorcode ? `<p><strong>–î–æ–º–æ—Ñ–æ–Ω:</strong> ${address.doorcode}</p>` : ''}
                                </div>
                            </div>
                        `;
                    }

                    if (items.length > 0) {
                        html += `
                            <div style="margin-bottom: 20px;">
                                <h3 style="margin-bottom: 15px;">üõçÔ∏è –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞</h3>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    ${items.map(item => `
                                        <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #dee2e6;">
                                            <div style="display: flex; justify-content: space-between;">
                                                <div>
                                                    <strong>${item.name}</strong><br>
                                                    <small>${item.quantity} √ó ${item.price} ‚ÇΩ</small>
                                                </div>
                                                <div style="font-weight: bold;">${item.quantity * item.price} ‚ÇΩ</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #ddd;">
                                        <div style="display: flex; justify-content: space-between; font-weight: bold;">
                                            <div>–ò—Ç–æ–≥–æ:</div>
                                            <div>${order.total_price || 0} ‚ÇΩ</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    if (order.delivery_notes) {
                        html += `
                            <div style="margin-bottom: 20px;">
                                <h3 style="margin-bottom: 15px;">üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞</h3>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <p>${order.delivery_notes}</p>
                                </div>
                            </div>
                        `;
                    }

                    if (order.photo_proof) {
                        html += `
                            <div style="margin-bottom: 20px;">
                                <h3 style="margin-bottom: 15px;">üì∑ –§–æ—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</h3>
                                <div style="text-align: center;">
                                    <img src="${order.photo_proof}" alt="–§–æ—Ç–æ –¥–æ—Å—Ç–∞–≤–∫–∏" style="max-width: 100%; border-radius: 8px; border: 1px solid #ddd;">
                                </div>
                            </div>
                        `;
                    }

                    document.getElementById('modal-order-id').textContent = orderId;
                    document.getElementById('modal-content').innerHTML = html;
                    document.getElementById('order-modal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error loading order details:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞');
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
        async function updateOrderStatus(orderId, status) {
            try {
                const response = await fetch('/api/courier/update-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        order_id: orderId,
                        courier_id: currentCourier.id,
                        status: status
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ #${orderId} –æ–±–Ω–æ–≤–ª–µ–Ω`);
                    loadActiveOrders();
                    loadStatistics();
                } else {
                    alert(data.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –¥–æ—Å—Ç–∞–≤–∫–∏ —Å —Ñ–æ—Ç–æ
        async function showDeliveryForm(orderId) {
            currentOrderId = orderId;
            currentPhoto = null;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ
            try {
                const response = await fetch(`/api/courier/order/${orderId}`);
                const data = await response.json();

                if (data.success) {
                    const order = data.order;
                    const address = order.delivery_address_obj || {};
                    const items = order.items_list || [];

                    // –§–æ—Ä–º–∏—Ä—É–µ–º –∞–¥—Ä–µ—Å
                    let addressText = '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω';
                    if (address.city || address.street) {
                        addressText = `${address.city || ''}, ${addr.street || ''} ${addr.house || ''}`;
                        if (addr.apartment) addressText += `, –∫–≤. ${addr.apartment}`;
                    }

                    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞
                    let itemsText = '';
                    if (items.length > 0) {
                        items.forEach(item => {
                            itemsText += `${item.name} √ó ${item.quantity} = ${item.quantity * item.price} ‚ÇΩ\n`;
                        });
                    }

                    let html = `
                        <div class="photo-upload">
                            <div style="margin-bottom: 20px;">
                                <h3 style="margin-bottom: 10px;">üì¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ #${order.id}</h3>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <p><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> ${order.recipient_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                    <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${order.phone_number || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                    <p><strong>–ê–¥—Ä–µ—Å:</strong> ${addressText}</p>
                                    <p><strong>–°—É–º–º–∞:</strong> ${order.total_price || 0} ‚ÇΩ</p>
                                </div>
                            </div>

                            <h4 style="margin-bottom: 15px;">üì∏ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏</h4>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px;">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∫ –¥–æ—Å—Ç–∞–≤–∫–µ:</label>
                                <textarea id="delivery-notes" style="width: 100%; padding: 10px; border-radius: 6px; border: 2px solid #e0e0e0;" rows="3" placeholder="–ö–ª–∏–µ–Ω—Ç –±—ã–ª –¥–æ–º–∞, –ø–µ—Ä–µ–¥–∞–ª –ª–∏—á–Ω–æ..."></textarea>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px;">–§–æ—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn-action" onclick="document.getElementById('cameraInput').click()" style="flex: 1;">
                                        üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ
                                    </button>
                                    <button class="btn-action" onclick="document.getElementById('galleryInput').click()" style="flex: 1;">
                                        üñºÔ∏è –í—ã–±—Ä–∞—Ç—å –∏–∑ –≥–∞–ª–µ—Ä–µ–∏
                                    </button>
                                </div>
                                <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
                                <input type="file" id="galleryInput" accept="image/*" style="display: none;">
                            </div>

                            <div id="photo-preview" class="photo-preview"></div>

                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn-action btn-deliver" onclick="completeDelivery()" id="confirmDeliveryBtn" disabled>
                                    ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É
                                </button>
                                <button class="btn-action" onclick="closeModal()">
                                    ‚ùå –û—Ç–º–µ–Ω–∞
                                </button>
                            </div>
                        </div>
                    `;

                    document.getElementById('modal-order-id').textContent = orderId;
                    document.getElementById('modal-content').innerHTML = html;
                    document.getElementById('order-modal').style.display = 'flex';

                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–æ—Ç–æ
                    document.getElementById('cameraInput').addEventListener('change', handlePhotoSelection);
                    document.getElementById('galleryInput').addEventListener('change', handlePhotoSelection);
                }
            } catch (error) {
                console.error('Error loading order for delivery:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–∫–∞–∑–µ');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ
        function handlePhotoSelection(e) {
            const file = e.target.files[0];
            if (!file) return;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
            if (!file.type.startsWith('image/')) {
                alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä (–º–∞–∫—Å 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 5MB)');
                return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                currentPhoto = {
                    data: e.target.result,
                    file: file
                };

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                const preview = document.getElementById('photo-preview');
                preview.innerHTML = `<img src="${e.target.result}" alt="–í—ã–±—Ä–∞–Ω–Ω–æ–µ —Ñ–æ—Ç–æ">`;
                preview.style.display = 'block';

                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                document.getElementById('confirmDeliveryBtn').disabled = false;
            };

            reader.readAsDataURL(file);
        }

        // –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É
        async function completeDelivery() {
            const notes = document.getElementById('delivery-notes').value;

            if (!currentPhoto) {
                alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏');
                return;
            }

            try {
                const response = await fetch('/api/courier/update-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        order_id: currentOrderId,
                        courier_id: currentCourier.id,
                        status: 'delivered',
                        photo_data: currentPhoto.data,
                        notes: notes
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ –ó–∞–∫–∞–∑ #${currentOrderId} —É—Å–ø–µ—à–Ω–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω!`);
                    closeModal();
                    loadActiveOrders();
                    loadCompletedOrders();
                    loadStatistics();

                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ç–æ
                    currentPhoto = null;
                    currentOrderId = null;
                } else {
                    alert(data.error || '–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏');
                }
            } catch (error) {
                console.error('Error completing delivery:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        async function saveProfile() {
            const fullName = document.getElementById('profile-fullname').value;
            const phone = document.getElementById('profile-phone').value;
            const vehicle = document.getElementById('profile-vehicle').value;

            if (!fullName || !phone) {
                showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            try {
                const response = await fetch('/api/courier/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        courier_id: currentCourier.id,
                        full_name: fullName,
                        phone: phone,
                        vehicle_type: vehicle
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
                    currentCourier = data.profile;
                    updateCourierInfo();
                } else {
                    showMessage(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è', 'error');
                }
            } catch (error) {
                console.error('Error saving profile:', error);
                showMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è', 'error');
            }
        }

        // –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
        async function changePassword() {
            const currentPass = document.getElementById('current-password').value;
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;

            if (!currentPass || !newPass || !confirmPass) {
                showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            if (newPass.length < 6) {
                showMessage('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                return;
            }

            if (newPass !== confirmPass) {
                showMessage('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
                return;
            }

            try {
                const response = await fetch('/api/courier/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        courier_id: currentCourier.id,
                        old_password: currentPass,
                        new_password: newPass
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω', 'success');
                    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';
                } else {
                    showMessage(data.error || '–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è', 'error');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showMessage('–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è', 'error');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(text, type) {
            const div = document.getElementById('settings-message');
            div.textContent = text;
            div.className = type + '-message';
            div.style.display = 'block';

            setTimeout(() => {
                div.style.display = 'none';
            }, 5000);
        }

        // –í—ã–π—Ç–∏
        function logout() {
            if (confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                localStorage.removeItem('courier_data');
                currentCourier = null;
                currentToken = null;

                document.getElementById('main-screen').style.display = 'none';
                document.getElementById('login-screen').style.display = 'block';

                // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –≤—Ö–æ–¥–∞
                document.getElementById('login-username').value = '';
                document.getElementById('login-password').value = '';
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function closeModal() {
            document.getElementById('order-modal').style.display = 'none';
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ç–æ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
            currentPhoto = null;
            currentOrderId = null;
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞
        function getStatusText(status) {
            const statuses = {
                'assigned': '–ù–∞–∑–Ω–∞—á–µ–Ω',
                'picked_up': '–í –¥–æ—Å—Ç–∞–≤–∫–µ',
                'delivered': '–î–æ—Å—Ç–∞–≤–ª–µ–Ω',
                'pending': '–û–∂–∏–¥–∞–µ—Ç',
                'processing': '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ'
            };
            return statuses[status] || status;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
        document.getElementById('order-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
    <script src="/static/js/courier.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        document.addEventListener('DOMContentLoaded', () => {
            window.courierApp = new CourierApp();
            console.log('‚úÖ CourierApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        });
    </script>
</body>
</html>